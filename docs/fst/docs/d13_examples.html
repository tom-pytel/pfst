<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 15.0.1"/>
    <title>fst.docs.d13_examples API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:.75rem center;margin-bottom:1rem;}.pdoc .alert > em{display:none;}.pdoc .alert > *:last-child{margin-bottom:0;}.pdoc .alert.note {color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .alert.warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .alert.danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .decorator-deprecated{color:#842029;}.pdoc .decorator-deprecated ~ span{filter:grayscale(1) opacity(0.8);}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../docs.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;fst.docs</a>



            <h2>Contents</h2>
            <ul>
  <li><a href="#example-recipes">Example recipes</a>
  <ul>
    <li><a href="#type-annotations-to-type-comments">Type annotations to type comments</a></li>
    <li><a href="#inject-logging-metadata">Inject logging metadata</a></li>
    <li><a href="#else-if-chain-to-elif"><code>else if</code> chain to <code>elif</code></a></li>
    <li><a href="#pull-out-nested-functions">Pull out nested functions</a></li>
    <li><a href="#lambda-to-def"><code>lambda</code> to <code>def</code></a></li>
    <li><a href="#isinstance-to-__class__-is-in"><code>isinstance()</code> to <code>__class__ is</code> / <code>in</code></a></li>
    <li><a href="#squash-nested-withs">Squash nested <code>with</code>s</a></li>
    <li><a href="#add-decorator-to-class-methods">Add decorator to class methods</a></li>
    <li><a href="#comprehension-to-loop">Comprehension to loop</a></li>
    <li><a href="#align-equals">Align equals</a></li>
    <li><a href="#make-all-f-strings-self-documenting">Make all f-strings self-documenting</a></li>
    <li><a href="#normalize-docstrings">Normalize docstrings</a></li>
    <li><a href="#reparenthesize-expressions">Reparenthesize expressions</a></li>
    <li><a href="#instrument-expressions">Instrument expressions</a></li>
  </ul></li>
</ul>





        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="./../../fst.html">fst</a><wbr>.<a href="./../docs.html">docs</a><wbr>.d13_examples    </h1>

                        <div class="docstring"><h1 id="example-recipes">Example recipes</h1>

<p>These are a few snippets which do some real-world-ish things. The comment handling blemishes are left in place and your
actual mileage with comments at the edges of modifications will vary. It depends very much of correct usage of the
<code>trivia</code> option both on <code>get()</code> and <code>put()</code>, and comment handling in general needs a bit more work (a lot more work),
but they are preserved mostly.</p>

<p>The examples are deliberately not the most efficient but are rather meant to show off <code><a href="../../fst.html">fst</a></code> usage and features. Some of
them are somewhat formatter-y, which is not the intended use of this module, but fine for demonstration purposes. If you
want to see an example of an intended use case then see <a href="#instrument-expressions">Instrument expressions</a>.</p>

<p>You will see a lot of <code>.replace()</code> of nodes while <code>.walk()</code>ing them, this is allowed as <code>walk()</code> is really a
<code>transform()</code> function, see <code><a href="../fst.html#FST.walk">fst.fst.FST.walk()</a></code> for more details.</p>

<p>To be able to execute the examples, import this.</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">fst</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
</code></pre>
</div>

<p>This is just a print helper function for this documentation, you can ignore it.</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="k">def</span><span class="w"> </span><span class="nf">pprint</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>  <span class="c1"># helper</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n\xa0\n</span><span class="s1">&#39;</span><span class="p">))</span>  <span class="c1"># replace() to avoid &#39;&lt;BLANKLINE&gt;&#39;</span>
</code></pre>
</div>

<h2 id="type-annotations-to-type-comments">Type annotations to type comments</h2>

<p>This doesn't do full validation and there could be extra functionality added for class attributes and updates if they
are set in a constructor, but should be enough to show how something more complete would be done.</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="k">def</span><span class="w"> </span><span class="nf">type_annotations_to_type_comments</span><span class="p">(</span><span class="n">src</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="o">...</span>     <span class="n">fst_</span> <span class="o">=</span> <span class="n">FST</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;exec&#39;</span><span class="p">)</span>  <span class="c1"># same as &quot;fst.parse(src).f&quot;</span>
<span class="o">...</span>
<span class="o">...</span>     <span class="c1"># walk the whole tree but only yield AnnAssign nodes</span>
<span class="o">...</span>     <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fst_</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">AnnAssign</span><span class="p">):</span>
<span class="o">...</span>         <span class="c1"># if just an annotation then skip it, alternatively could</span>
<span class="o">...</span>         <span class="c1"># clean and store for later addition to __init__() assign in class</span>
<span class="o">...</span>         <span class="k">if</span> <span class="ow">not</span> <span class="n">f</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
<span class="o">...</span>             <span class="k">continue</span>
<span class="o">...</span>
<span class="o">...</span>         <span class="c1"># &#39;.own_src()&#39; gives us the original source exactly as written dedented</span>
<span class="o">...</span>         <span class="n">target</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">own_src</span><span class="p">()</span>
<span class="o">...</span>         <span class="n">value</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">own_src</span><span class="p">()</span>
<span class="o">...</span>
<span class="o">...</span>         <span class="c1"># we use ast_src() for the annotation to get a clean type string</span>
<span class="o">...</span>         <span class="n">annotation</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">annotation</span><span class="o">.</span><span class="n">ast_src</span><span class="p">()</span>
<span class="o">...</span>
<span class="o">...</span>         <span class="c1"># preserve any existing end-of-line comment</span>
<span class="o">...</span>         <span class="n">comment</span> <span class="o">=</span> <span class="s1">&#39; # &#39;</span> <span class="o">+</span> <span class="n">comment</span> <span class="k">if</span> <span class="p">(</span><span class="n">comment</span> <span class="o">:=</span> <span class="n">f</span><span class="o">.</span><span class="n">get_line_comment</span><span class="p">())</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
<span class="o">...</span>
<span class="o">...</span>         <span class="c1"># reconstruct the line using the PEP 484 type comment style</span>
<span class="o">...</span>         <span class="n">new_src</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s1"> = </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s1">  # type: </span><span class="si">{</span><span class="n">annotation</span><span class="si">}{</span><span class="n">comment</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="o">...</span>
<span class="o">...</span>         <span class="c1"># replace the node, trivia=False preserves any leading comments</span>
<span class="o">...</span>         <span class="n">f</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">new_src</span><span class="p">,</span> <span class="n">trivia</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="o">...</span>
<span class="o">...</span>     <span class="k">return</span> <span class="n">fst_</span><span class="o">.</span><span class="n">src</span>  <span class="c1"># same as fst.unparse(fst_.a)</span>
</code></pre>
</div>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">src</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">... def func():</span>
<span class="s2">...     normal = assign</span>
<span class="s2">...</span>
<span class="s2">...     x: int = 1</span>
<span class="s2">...</span>
<span class="s2">...     # y is such and such</span>
<span class="s2">...     y: float = 2.0  # more about y</span>
<span class="s2">...     # y was a good variable...</span>
<span class="s2">...</span>
<span class="s2">...     structure: tuple[</span>
<span class="s2">...         tuple[int, int],  # extraneous comment</span>
<span class="s2">...         dict[str, Any],   # could break stuff</span>
<span class="s2">...     ] | None = None# blah</span>
<span class="s2">...</span>
<span class="s2">...     call(  # invalid but just for demonstration purposes</span>
<span class="s2">...         some_arg,          # non-extraneous comment</span>
<span class="s2">...         some_kw=kw_value,  # will not break stuff</span>
<span class="s2">...     )[start : stop].attr: SomeClass = getthis()</span>
<span class="s2">... &quot;&quot;&quot;</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</code></pre>
</div>

<p>Original.</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">pprint</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">func</span><span class="p">():</span>
    <span class="n">normal</span> <span class="o">=</span> <span class="n">assign</span>
 
    <span class="n">x</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
 
    <span class="c1"># y is such and such</span>
    <span class="n">y</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span>  <span class="c1"># more about y</span>
    <span class="c1"># y was a good variable...</span>
 
    <span class="n">structure</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span>
        <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>  <span class="c1"># extraneous comment</span>
        <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>   <span class="c1"># could break stuff</span>
    <span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="c1"># blah</span>
 
    <span class="n">call</span><span class="p">(</span>  <span class="c1"># invalid but just for demonstration purposes</span>
        <span class="n">some_arg</span><span class="p">,</span>          <span class="c1"># non-extraneous comment</span>
        <span class="n">some_kw</span><span class="o">=</span><span class="n">kw_value</span><span class="p">,</span>  <span class="c1"># will not break stuff</span>
    <span class="p">)[</span><span class="n">start</span> <span class="p">:</span> <span class="n">stop</span><span class="p">]</span><span class="o">.</span><span class="n">attr</span><span class="p">:</span> <span class="n">SomeClass</span> <span class="o">=</span> <span class="n">getthis</span><span class="p">()</span>
</code></pre>
</div>

<p>Processed:</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">pprint</span><span class="p">(</span><span class="n">type_annotations_to_type_comments</span><span class="p">(</span><span class="n">src</span><span class="p">))</span>
<span class="k">def</span><span class="w"> </span><span class="nf">func</span><span class="p">():</span>
    <span class="n">normal</span> <span class="o">=</span> <span class="n">assign</span>
 
    <span class="n">x</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># type: int</span>
 
    <span class="c1"># y is such and such</span>
    <span class="n">y</span> <span class="o">=</span> <span class="mf">2.0</span>  <span class="c1"># type: float # more about y</span>
    <span class="c1"># y was a good variable...</span>
 
    <span class="n">structure</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: tuple[tuple[int, int], dict[str, Any]] | None # blah</span>
 
    <span class="n">call</span><span class="p">(</span>  <span class="c1"># invalid but just for demonstration purposes</span>
        <span class="n">some_arg</span><span class="p">,</span>          <span class="c1"># non-extraneous comment</span>
        <span class="n">some_kw</span><span class="o">=</span><span class="n">kw_value</span><span class="p">,</span>  <span class="c1"># will not break stuff</span>
    <span class="p">)[</span><span class="n">start</span> <span class="p">:</span> <span class="n">stop</span><span class="p">]</span><span class="o">.</span><span class="n">attr</span> <span class="o">=</span> <span class="n">getthis</span><span class="p">()</span>  <span class="c1"># type: SomeClass</span>
</code></pre>
</div>

<h2 id="inject-logging-metadata">Inject logging metadata</h2>

<p>You want to add a <code>correlation_id=CID</code> keyword argument to all <code>logger.info()</code> calls, but only if its not already there.</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="k">def</span><span class="w"> </span><span class="nf">inject_logging_metadata</span><span class="p">(</span><span class="n">src</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="o">...</span>     <span class="n">fst</span> <span class="o">=</span> <span class="n">FST</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;exec&#39;</span><span class="p">)</span>
<span class="o">...</span>
<span class="o">...</span>     <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fst</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">Call</span><span class="p">):</span>
<span class="o">...</span>         <span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">is_Attribute</span>
<span class="o">...</span>             <span class="ow">and</span> <span class="n">f</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">attr</span> <span class="o">==</span> <span class="s1">&#39;info&#39;</span>
<span class="o">...</span>             <span class="ow">and</span> <span class="n">f</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">is_Name</span>
<span class="o">...</span>             <span class="ow">and</span> <span class="n">f</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="s1">&#39;logger&#39;</span>
<span class="o">...</span>             <span class="ow">and</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">kw</span><span class="o">.</span><span class="n">arg</span> <span class="o">==</span> <span class="s1">&#39;correlation_id&#39;</span> <span class="k">for</span> <span class="n">kw</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">keywords</span><span class="p">)</span>
<span class="o">...</span>         <span class="p">):</span>
<span class="o">...</span>             <span class="n">f</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;correlation_id=CID&#39;</span><span class="p">,</span> <span class="n">trivia</span><span class="o">=</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
<span class="o">...</span>
<span class="o">...</span>     <span class="k">return</span> <span class="n">fst</span><span class="o">.</span><span class="n">src</span>
</code></pre>
</div>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">src</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">... logger.info(&#39;Hello world...&#39;)  # ok</span>
<span class="s2">... logger.info(&#39;Already have id&#39;, correlation_id=other_cid)  # ok</span>
<span class="s2">... logger.info()  # yes, no logger message, too bad</span>
<span class="s2">...</span>
<span class="s2">... class cls:</span>
<span class="s2">...     def method(self, thing, extra):</span>
<span class="s2">...         if not thing:</span>
<span class="s2">...             (logger).info(  # just checking</span>
<span class="s2">...                 f&#39;not a </span><span class="si">{thing}</span><span class="s2">&#39;,  # this is fine</span>
<span class="s2">...                 extra=extra,       # also this</span>
<span class="s2">...             )</span>
<span class="s2">... &quot;&quot;&quot;</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</code></pre>
</div>

<p>Original.</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">pprint</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Hello world...&#39;</span><span class="p">)</span>  <span class="c1"># ok</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Already have id&#39;</span><span class="p">,</span> <span class="n">correlation_id</span><span class="o">=</span><span class="n">other_cid</span><span class="p">)</span>  <span class="c1"># ok</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>  <span class="c1"># yes, no logger message, too bad</span>
 
<span class="k">class</span><span class="w"> </span><span class="nc">cls</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">thing</span><span class="p">,</span> <span class="n">extra</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">thing</span><span class="p">:</span>
            <span class="p">(</span><span class="n">logger</span><span class="p">)</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>  <span class="c1"># just checking</span>
                <span class="sa">f</span><span class="s1">&#39;not a </span><span class="si">{</span><span class="n">thing</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="c1"># this is fine</span>
                <span class="n">extra</span><span class="o">=</span><span class="n">extra</span><span class="p">,</span>       <span class="c1"># also this</span>
            <span class="p">)</span>
</code></pre>
</div>

<p>Processed:</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">pprint</span><span class="p">(</span><span class="n">inject_logging_metadata</span><span class="p">(</span><span class="n">src</span><span class="p">))</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Hello world...&#39;</span><span class="p">,</span> <span class="n">correlation_id</span><span class="o">=</span><span class="n">CID</span><span class="p">)</span>  <span class="c1"># ok</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Already have id&#39;</span><span class="p">,</span> <span class="n">correlation_id</span><span class="o">=</span><span class="n">other_cid</span><span class="p">)</span>  <span class="c1"># ok</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">correlation_id</span><span class="o">=</span><span class="n">CID</span><span class="p">)</span>  <span class="c1"># yes, no logger message, too bad</span>
 
<span class="k">class</span><span class="w"> </span><span class="nc">cls</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">thing</span><span class="p">,</span> <span class="n">extra</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">thing</span><span class="p">:</span>
            <span class="p">(</span><span class="n">logger</span><span class="p">)</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>  <span class="c1"># just checking</span>
                <span class="sa">f</span><span class="s1">&#39;not a </span><span class="si">{</span><span class="n">thing</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>  <span class="c1"># this is fine</span>
                <span class="n">extra</span><span class="o">=</span><span class="n">extra</span><span class="p">,</span>       <span class="c1"># also this</span>
                <span class="n">correlation_id</span><span class="o">=</span><span class="n">CID</span>
            <span class="p">)</span>
</code></pre>
</div>

<h2 id="else-if-chain-to-elif"><code>else if</code> chain to <code>elif</code></h2>

<p><code><a href="../../fst.html">fst</a></code> has <code>elif</code> &lt;-> <code>else if</code> code built in as its needed for statement insertions and deletions from conditional
bodies so its fairly easy to leverage to change these kinds of chains. The inverse of this operation can be done just
by changing the <code>f.is_elif()</code> check to <code>is True</code> and the <code>elif_</code> parameter to <code>elif_=False</code> in the <code>replace()</code>, though
you may need to tweak the <code>trivia</code> parameters for best results.</p>

<p>Yes the comments on the replaced <code>else</code> headers disappear. Could preserve them explicitly by using <code>get_line_comment()</code>
and then inserting them above the <code>if</code> manually using <code>put_src()</code>. Eventually should make this automatic.</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="k">def</span><span class="w"> </span><span class="nf">else_if_chain_to_elifs</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
<span class="o">...</span>     <span class="n">fst</span> <span class="o">=</span> <span class="n">FST</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;exec&#39;</span><span class="p">)</span>
<span class="o">...</span>
<span class="o">...</span>     <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fst</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">If</span><span class="p">):</span>  <span class="c1"># we will only get the `ast.If` nodes</span>
<span class="o">...</span>         <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">orelse</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
<span class="o">...</span>             <span class="ow">and</span> <span class="n">f</span><span class="o">.</span><span class="n">orelse</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">is_elif</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">False</span>  <span class="c1"># False means normal `if`</span>
<span class="o">...</span>         <span class="p">):</span>
<span class="o">...</span>             <span class="n">f</span><span class="o">.</span><span class="n">orelse</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>  <span class="c1"># can replace while walking</span>
<span class="o">...</span>                 <span class="n">f</span><span class="o">.</span><span class="n">orelse</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">trivia</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;block&#39;</span><span class="p">,</span> <span class="s1">&#39;all&#39;</span><span class="p">)),</span>
<span class="o">...</span>                 <span class="n">trivia</span><span class="o">=</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;all&#39;</span><span class="p">),</span>  <span class="c1"># trivia specifies how to handle comments</span>
<span class="o">...</span>                 <span class="n">elif_</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># elif_=True is default, here to show usage</span>
<span class="o">...</span>             <span class="p">)</span>
<span class="o">...</span>
<span class="o">...</span>     <span class="k">return</span> <span class="n">fst</span><span class="o">.</span><span class="n">src</span>
</code></pre>
</div>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">src</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">... def func():</span>
<span class="s2">...     # pre-if-a</span>
<span class="s2">...     if a:  # if-a</span>
<span class="s2">...         # pre-i</span>
<span class="s2">...         i = 1  # i</span>
<span class="s2">...         # post-i</span>
<span class="s2">...</span>
<span class="s2">...     else:  # else-a</span>
<span class="s2">...         # pre-if-b</span>
<span class="s2">...         if b:  # if-b</span>
<span class="s2">...             # pre-j</span>
<span class="s2">...             j = 2  # j</span>
<span class="s2">...             # post-j</span>
<span class="s2">...</span>
<span class="s2">...         else:  # else-b</span>
<span class="s2">...             # pre-if-c</span>
<span class="s2">...             if c:  # if-c</span>
<span class="s2">...                 # pre-k</span>
<span class="s2">...                 k = 3  # k</span>
<span class="s2">...                 # post-k</span>
<span class="s2">...</span>
<span class="s2">...             else:  # else-c</span>
<span class="s2">...                 # pre-l</span>
<span class="s2">...                 l = 4  # l</span>
<span class="s2">...                 # post-l</span>
<span class="s2">...</span>
<span class="s2">...             # post-else-c</span>
<span class="s2">...</span>
<span class="s2">...         # post-else-b</span>
<span class="s2">...</span>
<span class="s2">...     # post-else-a</span>
<span class="s2">... &quot;&quot;&quot;</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</code></pre>
</div>

<p>Original:</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">pprint</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">func</span><span class="p">():</span>
    <span class="c1"># pre-if-a</span>
    <span class="k">if</span> <span class="n">a</span><span class="p">:</span>  <span class="c1"># if-a</span>
        <span class="c1"># pre-i</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># i</span>
        <span class="c1"># post-i</span>
 
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># else-a</span>
        <span class="c1"># pre-if-b</span>
        <span class="k">if</span> <span class="n">b</span><span class="p">:</span>  <span class="c1"># if-b</span>
            <span class="c1"># pre-j</span>
            <span class="n">j</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># j</span>
            <span class="c1"># post-j</span>
 
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># else-b</span>
            <span class="c1"># pre-if-c</span>
            <span class="k">if</span> <span class="n">c</span><span class="p">:</span>  <span class="c1"># if-c</span>
                <span class="c1"># pre-k</span>
                <span class="n">k</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># k</span>
                <span class="c1"># post-k</span>
 
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># else-c</span>
                <span class="c1"># pre-l</span>
                <span class="n">l</span> <span class="o">=</span> <span class="mi">4</span>  <span class="c1"># l</span>
                <span class="c1"># post-l</span>
 
            <span class="c1"># post-else-c</span>
 
        <span class="c1"># post-else-b</span>
 
    <span class="c1"># post-else-a</span>
</code></pre>
</div>

<p>Processed:</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">pprint</span><span class="p">(</span><span class="n">else_if_chain_to_elifs</span><span class="p">(</span><span class="n">src</span><span class="p">))</span>
<span class="k">def</span><span class="w"> </span><span class="nf">func</span><span class="p">():</span>
    <span class="c1"># pre-if-a</span>
    <span class="k">if</span> <span class="n">a</span><span class="p">:</span>  <span class="c1"># if-a</span>
        <span class="c1"># pre-i</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># i</span>
        <span class="c1"># post-i</span>
 
    <span class="c1"># pre-if-b</span>
    <span class="k">elif</span> <span class="n">b</span><span class="p">:</span>  <span class="c1"># if-b</span>
        <span class="c1"># pre-j</span>
        <span class="n">j</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># j</span>
        <span class="c1"># post-j</span>
 
    <span class="c1"># pre-if-c</span>
    <span class="k">elif</span> <span class="n">c</span><span class="p">:</span>  <span class="c1"># if-c</span>
        <span class="c1"># pre-k</span>
        <span class="n">k</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># k</span>
        <span class="c1"># post-k</span>
 
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># else-c</span>
        <span class="c1"># pre-l</span>
        <span class="n">l</span> <span class="o">=</span> <span class="mi">4</span>  <span class="c1"># l</span>
        <span class="c1"># post-l</span>
 
    <span class="c1"># post-else-c</span>
 
    <span class="c1"># post-else-b</span>
 
    <span class="c1"># post-else-a</span>
</code></pre>
</div>

<h2 id="pull-out-nested-functions">Pull out nested functions</h2>

<p>This is a bit trickier than it sounds because of possible nonlocal accesses by the inner functions. This is solved by
checking for those accesses and not pulling those functions out. Names are also changed to avoid collision at the global
scope.</p>

<p>The nonlocal variable check is not complete as a full check would check if the "free" symbols aren't actually global or
builtins, in which case they can be ignored and the function can be moved. We also don't check possible <code>type_params</code>
or function <code>returns</code> fields for possible nonlocal references but just assume they are all global for this example. We
also don't check for name override in children when replacing function name, but that is another detail not needed for
demonstration purposes.</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="k">def</span><span class="w"> </span><span class="nf">pull_out_inner_funcs_safely</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
<span class="o">...</span>     <span class="n">fst</span> <span class="o">=</span> <span class="n">FST</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;exec&#39;</span><span class="p">)</span>
<span class="o">...</span>
<span class="o">...</span>     <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fst</span><span class="o">.</span><span class="n">walk</span><span class="p">({</span><span class="n">FunctionDef</span><span class="p">,</span> <span class="n">AsyncFunctionDef</span><span class="p">}):</span>
<span class="o">...</span>         <span class="k">if</span> <span class="p">(</span><span class="n">parent_scope</span> <span class="o">:=</span> <span class="n">f</span><span class="o">.</span><span class="n">parent_named_scope</span><span class="p">())</span><span class="o">.</span><span class="n">is_funcdef</span><span class="p">:</span>  <span class="c1"># func in a func</span>
<span class="o">...</span>             <span class="n">func_name</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span>
<span class="o">...</span>             <span class="n">syms</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">scope_symbols</span><span class="p">(</span><span class="n">full</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="o">...</span>
<span class="o">...</span>             <span class="c1"># ignore any reference of function to itself</span>
<span class="o">...</span>             <span class="k">if</span> <span class="n">func_name</span> <span class="ow">in</span> <span class="n">syms</span><span class="p">[</span><span class="s1">&#39;free&#39;</span><span class="p">]:</span>
<span class="o">...</span>                 <span class="k">del</span> <span class="n">syms</span><span class="p">[</span><span class="s1">&#39;free&#39;</span><span class="p">][</span><span class="n">func_name</span><span class="p">]</span>
<span class="o">...</span>
<span class="o">...</span>             <span class="c1"># check if the inner function uses explicit or implicit nonlocals</span>
<span class="o">...</span>             <span class="k">if</span> <span class="n">syms</span><span class="p">[</span><span class="s1">&#39;nonlocal&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">syms</span><span class="p">[</span><span class="s1">&#39;free&#39;</span><span class="p">]:</span>
<span class="o">...</span>                 <span class="k">continue</span>
<span class="o">...</span>
<span class="o">...</span>             <span class="c1"># check if any function args defaults use variables</span>
<span class="o">...</span>             <span class="k">if</span> <span class="nb">next</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">Name</span><span class="p">),</span> <span class="kc">False</span><span class="p">):</span>
<span class="o">...</span>                 <span class="k">continue</span>
<span class="o">...</span>
<span class="o">...</span>             <span class="c1"># build global name from enclosing scopes</span>
<span class="o">...</span>             <span class="n">global_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">parent_scope</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">func_name</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="o">...</span>             <span class="n">top_scope</span> <span class="o">=</span> <span class="n">parent_scope</span>
<span class="o">...</span>
<span class="o">...</span>             <span class="k">while</span> <span class="n">up_scope</span> <span class="o">:=</span> <span class="n">top_scope</span><span class="o">.</span><span class="n">parent_named_scope</span><span class="p">(</span><span class="n">mod</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="o">...</span>                 <span class="n">top_scope</span> <span class="o">=</span> <span class="n">up_scope</span>
<span class="o">...</span>                 <span class="n">global_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">top_scope</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">global_name</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="o">...</span>
<span class="o">...</span>             <span class="c1"># replace all occurrences of original inner name with new global one</span>
<span class="o">...</span>             <span class="c1"># we do this first so that it includes the function being moved</span>
<span class="o">...</span>             <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">parent_scope</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">Name</span><span class="p">):</span>
<span class="o">...</span>                 <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">func_name</span><span class="p">:</span>
<span class="o">...</span>                     <span class="n">g</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">global_name</span><span class="p">)</span>
<span class="o">...</span>
<span class="o">...</span>             <span class="n">f</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">cut</span><span class="p">()</span>
<span class="o">...</span>             <span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">global_name</span>
<span class="o">...</span>
<span class="o">...</span>             <span class="c1"># insert just before our top-level scope</span>
<span class="o">...</span>             <span class="n">fst</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">top_scope</span><span class="o">.</span><span class="n">pfield</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">pep8space</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="o">...</span>
<span class="o">...</span>     <span class="k">return</span> <span class="n">fst</span><span class="o">.</span><span class="n">src</span>
</code></pre>
</div>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">src</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">... def get_lookup(val):</span>
<span class="s2">...     if not val:</span>
<span class="s2">...         return</span>
<span class="s2">...</span>
<span class="s2">...     def closure():  # can&#39;t pull out because of closure</span>
<span class="s2">...         return val[0]</span>
<span class="s2">...</span>
<span class="s2">...     def default_arg(val=val):  # can&#39;t pull out because of default arg</span>
<span class="s2">...         return val[0]</span>
<span class="s2">...</span>
<span class="s2">...     def safe(val):  # safe to pull out</span>
<span class="s2">...         return val[0]</span>
<span class="s2">...</span>
<span class="s2">...     return closure, default_arg, safe</span>
<span class="s2">...</span>
<span class="s2">... class cls:</span>
<span class="s2">...     def method1(self, a, b):</span>
<span class="s2">...         def fib(n):  # recursive for fun</span>
<span class="s2">...             if n &lt;= 1:</span>
<span class="s2">...                 return n</span>
<span class="s2">...</span>
<span class="s2">...             return fib(n - 1) + fib(n - 2)</span>
<span class="s2">...</span>
<span class="s2">...         return fib(n)</span>
<span class="s2">... &quot;&quot;&quot;</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</code></pre>
</div>

<p>Original:</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">pprint</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_lookup</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">val</span><span class="p">:</span>
        <span class="k">return</span>
 
    <span class="k">def</span><span class="w"> </span><span class="nf">closure</span><span class="p">():</span>  <span class="c1"># can&#39;t pull out because of closure</span>
        <span class="k">return</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
 
    <span class="k">def</span><span class="w"> </span><span class="nf">default_arg</span><span class="p">(</span><span class="n">val</span><span class="o">=</span><span class="n">val</span><span class="p">):</span>  <span class="c1"># can&#39;t pull out because of default arg</span>
        <span class="k">return</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
 
    <span class="k">def</span><span class="w"> </span><span class="nf">safe</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>  <span class="c1"># safe to pull out</span>
        <span class="k">return</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
 
    <span class="k">return</span> <span class="n">closure</span><span class="p">,</span> <span class="n">default_arg</span><span class="p">,</span> <span class="n">safe</span>
 
<span class="k">class</span><span class="w"> </span><span class="nc">cls</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">method1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">fib</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>  <span class="c1"># recursive for fun</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">n</span>
 
            <span class="k">return</span> <span class="n">fib</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">fib</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
 
        <span class="k">return</span> <span class="n">fib</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
</code></pre>
</div>

<p>Processed:</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">pprint</span><span class="p">(</span><span class="n">pull_out_inner_funcs_safely</span><span class="p">(</span><span class="n">src</span><span class="p">))</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_lookup_safe</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>  <span class="c1"># safe to pull out</span>
    <span class="k">return</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
 
<span class="k">def</span><span class="w"> </span><span class="nf">get_lookup</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">val</span><span class="p">:</span>
        <span class="k">return</span>
 
    <span class="k">def</span><span class="w"> </span><span class="nf">closure</span><span class="p">():</span>  <span class="c1"># can&#39;t pull out because of closure</span>
        <span class="k">return</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
 
    <span class="k">def</span><span class="w"> </span><span class="nf">default_arg</span><span class="p">(</span><span class="n">val</span><span class="o">=</span><span class="n">val</span><span class="p">):</span>  <span class="c1"># can&#39;t pull out because of default arg</span>
        <span class="k">return</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
 
    <span class="k">return</span> <span class="n">closure</span><span class="p">,</span> <span class="n">default_arg</span><span class="p">,</span> <span class="n">get_lookup_safe</span>
 
<span class="k">def</span><span class="w"> </span><span class="nf">cls_method1_fib</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>  <span class="c1"># recursive for fun</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">n</span>
 
    <span class="k">return</span> <span class="n">cls_method1_fib</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">cls_method1_fib</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
 
<span class="k">class</span><span class="w"> </span><span class="nc">cls</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">method1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">cls_method1_fib</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
</code></pre>
</div>

<h2 id="lambda-to-def"><code>lambda</code> to <code>def</code></h2>

<p>Maybe you have too many lambdas and want proper function defs for debugging or logging or other tools. Note the defs are
left in the same scope in case of nonlocals.</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="k">def</span><span class="w"> </span><span class="nf">lambdas_to_defs</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
<span class="o">...</span>     <span class="n">fst</span> <span class="o">=</span> <span class="n">FST</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;exec&#39;</span><span class="p">)</span>
<span class="o">...</span>     <span class="n">indent</span> <span class="o">=</span> <span class="n">fst</span><span class="o">.</span><span class="n">indent</span>  <span class="c1"># to show its there, inferred from src, single level str</span>
<span class="o">...</span>
<span class="o">...</span>     <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fst</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">Assign</span><span class="p">):</span>
<span class="o">...</span>         <span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">is_Lambda</span>
<span class="o">...</span>             <span class="ow">and</span> <span class="n">f</span><span class="o">.</span><span class="n">targets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">is_Name</span>
<span class="o">...</span>             <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">targets</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>   <span class="c1"># for demo purposes just deal with this case</span>
<span class="o">...</span>         <span class="p">):</span>
<span class="o">...</span>             <span class="n">flmb</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">value</span>
<span class="o">...</span>             <span class="n">fdef</span> <span class="o">=</span> <span class="n">FST</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">... def </span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">targets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="n">flmb</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">src</span><span class="si">}</span><span class="s2">):</span>
<span class="s2">... </span><span class="si">{</span><span class="n">indent</span><span class="si">}</span><span class="s2">return _</span>
<span class="s2">...                 &quot;&quot;&quot;</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>  <span class="c1"># template</span>
<span class="o">...</span>             <span class="n">fdef</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">flmb</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="o">...</span>
<span class="o">...</span>             <span class="c1"># explicitly preserve lambda line comment</span>
<span class="o">...</span>             <span class="n">fdef</span><span class="o">.</span><span class="n">put_line_comment</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">get_line_comment</span><span class="p">(</span><span class="n">full</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">full</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="o">...</span>
<span class="o">...</span>             <span class="n">f</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
<span class="o">...</span>                 <span class="n">fdef</span><span class="p">,</span>
<span class="o">...</span>                 <span class="n">trivia</span><span class="o">=</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;line&#39;</span><span class="p">),</span>  <span class="c1"># eat line comment but not leading</span>
<span class="o">...</span>                 <span class="n">pep8space</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>  <span class="c1"># don&#39;t doublespace inserted func def (at mod scope)</span>
<span class="o">...</span>             <span class="p">)</span>
<span class="o">...</span>
<span class="o">...</span>     <span class="k">return</span> <span class="n">fst</span><span class="o">.</span><span class="n">src</span>
</code></pre>
</div>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">src</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">... # lambda comment</span>
<span class="s2">... mymin = lambda a, b: a if a &lt; b else b  # inline lambda comment</span>
<span class="s2">...</span>
<span class="s2">... # class comment</span>
<span class="s2">... class cls:</span>
<span class="s2">...         name = lambda self: str(self)</span>
<span class="s2">...</span>
<span class="s2">...         def method(self, a, b):</span>
<span class="s2">...                 add = lambda a, b: a + b</span>
<span class="s2">...</span>
<span class="s2">...                 return add(a, b)</span>
<span class="s2">... &quot;&quot;&quot;</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</code></pre>
</div>

<p>Original:</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">pprint</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
<span class="c1"># lambda comment</span>
<span class="n">mymin</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">a</span> <span class="k">if</span> <span class="n">a</span> <span class="o">&lt;</span> <span class="n">b</span> <span class="k">else</span> <span class="n">b</span>  <span class="c1"># inline lambda comment</span>
 
<span class="c1"># class comment</span>
<span class="k">class</span><span class="w"> </span><span class="nc">cls</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="k">lambda</span> <span class="bp">self</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
 
        <span class="k">def</span><span class="w"> </span><span class="nf">method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
                <span class="n">add</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>
 
                <span class="k">return</span> <span class="n">add</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
</code></pre>
</div>

<p>Processed:</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">pprint</span><span class="p">(</span><span class="n">src</span> <span class="o">:=</span> <span class="n">lambdas_to_defs</span><span class="p">(</span><span class="n">src</span><span class="p">))</span>
<span class="c1"># lambda comment</span>
<span class="k">def</span><span class="w"> </span><span class="nf">mymin</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>  <span class="c1"># inline lambda comment</span>
        <span class="k">return</span> <span class="n">a</span> <span class="k">if</span> <span class="n">a</span> <span class="o">&lt;</span> <span class="n">b</span> <span class="k">else</span> <span class="n">b</span>
 
<span class="c1"># class comment</span>
<span class="k">class</span><span class="w"> </span><span class="nc">cls</span><span class="p">:</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
 
        <span class="k">def</span><span class="w"> </span><span class="nf">method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
                <span class="k">def</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
                        <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>
 
                <span class="k">return</span> <span class="n">add</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
</code></pre>
</div>

<p>Now lets also pull out the nested function.</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">pprint</span><span class="p">(</span><span class="n">pull_out_inner_funcs_safely</span><span class="p">(</span><span class="n">src</span><span class="p">))</span>
<span class="c1"># lambda comment</span>
<span class="k">def</span><span class="w"> </span><span class="nf">mymin</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>  <span class="c1"># inline lambda comment</span>
        <span class="k">return</span> <span class="n">a</span> <span class="k">if</span> <span class="n">a</span> <span class="o">&lt;</span> <span class="n">b</span> <span class="k">else</span> <span class="n">b</span>
 
<span class="k">def</span><span class="w"> </span><span class="nf">cls_method_add</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>
 
<span class="c1"># class comment</span>
<span class="k">class</span><span class="w"> </span><span class="nc">cls</span><span class="p">:</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
 
        <span class="k">def</span><span class="w"> </span><span class="nf">method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">cls_method_add</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
</code></pre>
</div>

<h2 id="isinstance-to-__class__-is-in"><code>isinstance()</code> to <code>__class__ is</code> / <code>in</code></h2>

<p>Maybe you realize that all your <code>isinstance()</code> checks are incurring a 1.3% performance penalty and you don't like that
so you want to replace them all in your codebase with direct class identity checks. This can be done for non-base
classes (like most <code>AST</code> types are).</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">NAMES</span> <span class="o">=</span> <span class="p">{</span>
<span class="o">...</span> <span class="s1">&#39;Add&#39;</span><span class="p">,</span> <span class="s1">&#39;And&#39;</span><span class="p">,</span> <span class="s1">&#39;AnnAssign&#39;</span><span class="p">,</span> <span class="s1">&#39;Assert&#39;</span><span class="p">,</span> <span class="s1">&#39;Assign&#39;</span><span class="p">,</span> <span class="s1">&#39;AsyncFor&#39;</span><span class="p">,</span> <span class="s1">&#39;AsyncFunctionDef&#39;</span><span class="p">,</span>
<span class="o">...</span> <span class="s1">&#39;AsyncWith&#39;</span><span class="p">,</span> <span class="s1">&#39;Attribute&#39;</span><span class="p">,</span> <span class="s1">&#39;AugAssign&#39;</span><span class="p">,</span> <span class="s1">&#39;Await&#39;</span><span class="p">,</span> <span class="s1">&#39;BinOp&#39;</span><span class="p">,</span> <span class="s1">&#39;BitAnd&#39;</span><span class="p">,</span> <span class="s1">&#39;BitOr&#39;</span><span class="p">,</span>
<span class="o">...</span> <span class="s1">&#39;BitXor&#39;</span><span class="p">,</span> <span class="s1">&#39;BoolOp&#39;</span><span class="p">,</span> <span class="s1">&#39;Break&#39;</span><span class="p">,</span> <span class="s1">&#39;Call&#39;</span><span class="p">,</span> <span class="s1">&#39;ClassDef&#39;</span><span class="p">,</span> <span class="s1">&#39;Compare&#39;</span><span class="p">,</span> <span class="s1">&#39;Constant&#39;</span><span class="p">,</span>
<span class="o">...</span> <span class="s1">&#39;Continue&#39;</span><span class="p">,</span> <span class="s1">&#39;Del&#39;</span><span class="p">,</span> <span class="s1">&#39;Delete&#39;</span><span class="p">,</span> <span class="s1">&#39;Dict&#39;</span><span class="p">,</span> <span class="s1">&#39;DictComp&#39;</span><span class="p">,</span> <span class="s1">&#39;Div&#39;</span><span class="p">,</span> <span class="s1">&#39;Eq&#39;</span><span class="p">,</span> <span class="s1">&#39;ExceptHandler&#39;</span><span class="p">,</span>
<span class="o">...</span> <span class="s1">&#39;Expr&#39;</span><span class="p">,</span> <span class="s1">&#39;Expression&#39;</span><span class="p">,</span> <span class="s1">&#39;FloorDiv&#39;</span><span class="p">,</span> <span class="s1">&#39;For&#39;</span><span class="p">,</span> <span class="s1">&#39;FormattedValue&#39;</span><span class="p">,</span> <span class="s1">&#39;FunctionDef&#39;</span><span class="p">,</span>
<span class="o">...</span> <span class="s1">&#39;FunctionType&#39;</span><span class="p">,</span> <span class="s1">&#39;GeneratorExp&#39;</span><span class="p">,</span> <span class="s1">&#39;Global&#39;</span><span class="p">,</span> <span class="s1">&#39;Gt&#39;</span><span class="p">,</span> <span class="s1">&#39;GtE&#39;</span><span class="p">,</span> <span class="s1">&#39;If&#39;</span><span class="p">,</span> <span class="s1">&#39;IfExp&#39;</span><span class="p">,</span> <span class="s1">&#39;Import&#39;</span><span class="p">,</span>
<span class="o">...</span> <span class="s1">&#39;ImportFrom&#39;</span><span class="p">,</span> <span class="s1">&#39;In&#39;</span><span class="p">,</span> <span class="s1">&#39;Interactive&#39;</span><span class="p">,</span> <span class="s1">&#39;Interpolation&#39;</span><span class="p">,</span> <span class="s1">&#39;Invert&#39;</span><span class="p">,</span> <span class="s1">&#39;Is&#39;</span><span class="p">,</span> <span class="s1">&#39;IsNot&#39;</span><span class="p">,</span>
<span class="o">...</span> <span class="s1">&#39;JoinedStr&#39;</span><span class="p">,</span> <span class="s1">&#39;LShift&#39;</span><span class="p">,</span> <span class="s1">&#39;Lambda&#39;</span><span class="p">,</span> <span class="s1">&#39;List&#39;</span><span class="p">,</span> <span class="s1">&#39;ListComp&#39;</span><span class="p">,</span> <span class="s1">&#39;Load&#39;</span><span class="p">,</span> <span class="s1">&#39;Lt&#39;</span><span class="p">,</span> <span class="s1">&#39;LtE&#39;</span><span class="p">,</span>
<span class="o">...</span> <span class="s1">&#39;MatMult&#39;</span><span class="p">,</span> <span class="s1">&#39;Match&#39;</span><span class="p">,</span> <span class="s1">&#39;MatchAs&#39;</span><span class="p">,</span> <span class="s1">&#39;MatchClass&#39;</span><span class="p">,</span> <span class="s1">&#39;MatchMapping&#39;</span><span class="p">,</span> <span class="s1">&#39;MatchOr&#39;</span><span class="p">,</span>
<span class="o">...</span> <span class="s1">&#39;MatchSequence&#39;</span><span class="p">,</span> <span class="s1">&#39;MatchSingleton&#39;</span><span class="p">,</span> <span class="s1">&#39;MatchStar&#39;</span><span class="p">,</span> <span class="s1">&#39;MatchValue&#39;</span><span class="p">,</span> <span class="s1">&#39;Mod&#39;</span><span class="p">,</span> <span class="s1">&#39;Module&#39;</span><span class="p">,</span>
<span class="o">...</span> <span class="s1">&#39;Mult&#39;</span><span class="p">,</span> <span class="s1">&#39;Name&#39;</span><span class="p">,</span> <span class="s1">&#39;NamedExpr&#39;</span><span class="p">,</span> <span class="s1">&#39;Nonlocal&#39;</span><span class="p">,</span> <span class="s1">&#39;Not&#39;</span><span class="p">,</span> <span class="s1">&#39;NotEq&#39;</span><span class="p">,</span> <span class="s1">&#39;NotIn&#39;</span><span class="p">,</span> <span class="s1">&#39;Or&#39;</span><span class="p">,</span>
<span class="o">...</span> <span class="s1">&#39;ParamSpec&#39;</span><span class="p">,</span> <span class="s1">&#39;Pass&#39;</span><span class="p">,</span> <span class="s1">&#39;Pow&#39;</span><span class="p">,</span> <span class="s1">&#39;RShift&#39;</span><span class="p">,</span> <span class="s1">&#39;Raise&#39;</span><span class="p">,</span> <span class="s1">&#39;Return&#39;</span><span class="p">,</span> <span class="s1">&#39;Set&#39;</span><span class="p">,</span> <span class="s1">&#39;SetComp&#39;</span><span class="p">,</span>
<span class="o">...</span> <span class="s1">&#39;Slice&#39;</span><span class="p">,</span> <span class="s1">&#39;Starred&#39;</span><span class="p">,</span> <span class="s1">&#39;Store&#39;</span><span class="p">,</span> <span class="s1">&#39;Sub&#39;</span><span class="p">,</span> <span class="s1">&#39;Subscript&#39;</span><span class="p">,</span> <span class="s1">&#39;TemplateStr&#39;</span><span class="p">,</span> <span class="s1">&#39;Try&#39;</span><span class="p">,</span> <span class="s1">&#39;TryStar&#39;</span><span class="p">,</span>
<span class="o">...</span> <span class="s1">&#39;Tuple&#39;</span><span class="p">,</span> <span class="s1">&#39;TypeAlias&#39;</span><span class="p">,</span> <span class="s1">&#39;TypeIgnore&#39;</span><span class="p">,</span> <span class="s1">&#39;TypeVar&#39;</span><span class="p">,</span> <span class="s1">&#39;TypeVarTuple&#39;</span><span class="p">,</span> <span class="s1">&#39;UAdd&#39;</span><span class="p">,</span> <span class="s1">&#39;USub&#39;</span><span class="p">,</span>
<span class="o">...</span> <span class="s1">&#39;UnaryOp&#39;</span><span class="p">,</span> <span class="s1">&#39;While&#39;</span><span class="p">,</span> <span class="s1">&#39;With&#39;</span><span class="p">,</span> <span class="s1">&#39;Yield&#39;</span><span class="p">,</span> <span class="s1">&#39;YieldFrom&#39;</span><span class="p">,</span> <span class="s1">&#39;alias&#39;</span><span class="p">,</span> <span class="s1">&#39;arg&#39;</span><span class="p">,</span> <span class="s1">&#39;arguments&#39;</span><span class="p">,</span>
<span class="o">...</span> <span class="s1">&#39;comprehension&#39;</span><span class="p">,</span> <span class="s1">&#39;keyword&#39;</span><span class="p">,</span> <span class="s1">&#39;match_case&#39;</span><span class="p">,</span> <span class="s1">&#39;withitem&#39;</span><span class="p">,</span>
<span class="o">...</span> <span class="p">}</span>

<span class="o">&gt;&gt;&gt;</span> <span class="k">def</span><span class="w"> </span><span class="nf">isinstance_to_class_check</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
<span class="o">...</span>     <span class="n">fst</span> <span class="o">=</span> <span class="n">FST</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;exec&#39;</span><span class="p">)</span>
<span class="o">...</span>
<span class="o">...</span>     <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fst</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">Call</span><span class="p">):</span>
<span class="o">...</span>         <span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">is_Name</span>
<span class="o">...</span>             <span class="ow">and</span> <span class="n">f</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="s1">&#39;isinstance&#39;</span>  <span class="c1"># isinstance()</span>
<span class="o">...</span>         <span class="p">):</span>
<span class="o">...</span>             <span class="n">ftest</span><span class="p">,</span> <span class="n">ftype</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">args</span>  <span class="c1"># assume there are two for isinstance()</span>
<span class="o">...</span>             <span class="n">fparent</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">parent</span>
<span class="o">...</span>
<span class="o">...</span>             <span class="c1"># isinstance(..., one of NAMES)</span>
<span class="o">...</span>             <span class="k">if</span> <span class="n">ftype</span><span class="o">.</span><span class="n">is_Name</span> <span class="ow">and</span> <span class="n">ftype</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="n">NAMES</span><span class="p">:</span>
<span class="o">...</span>                 <span class="n">op</span><span class="p">,</span> <span class="n">notop</span> <span class="o">=</span> <span class="s1">&#39;is&#39;</span><span class="p">,</span> <span class="s1">&#39;is not&#39;</span>
<span class="o">...</span>             <span class="c1"># isinstance(..., (one of NAMES, ...))</span>
<span class="o">...</span>             <span class="k">elif</span> <span class="p">(</span>
<span class="o">...</span>                 <span class="n">ftype</span><span class="o">.</span><span class="n">is_Tuple</span>
<span class="o">...</span>                 <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">is_Name</span> <span class="ow">and</span> <span class="n">g</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="n">NAMES</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">elts</span><span class="p">)</span>
<span class="o">...</span>             <span class="p">):</span>
<span class="o">...</span>                 <span class="n">op</span><span class="p">,</span> <span class="n">notop</span> <span class="o">=</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="s1">&#39;not in&#39;</span>
<span class="o">...</span>             <span class="k">else</span><span class="p">:</span>
<span class="o">...</span>                 <span class="k">continue</span>
<span class="o">...</span>
<span class="o">...</span>             <span class="c1"># &#39;not isinstance()&#39; -&gt; &#39;__class__ is not&#39; / &#39;not in&#39;</span>
<span class="o">...</span>             <span class="k">if</span> <span class="n">fparent</span><span class="o">.</span><span class="n">is_UnaryOp</span> <span class="ow">and</span> <span class="n">fparent</span><span class="o">.</span><span class="n">op</span><span class="o">.</span><span class="n">is_Not</span><span class="p">:</span>
<span class="o">...</span>                 <span class="n">f</span> <span class="o">=</span> <span class="n">fparent</span>
<span class="o">...</span>                 <span class="n">fparent</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">parent</span>
<span class="o">...</span>                 <span class="n">op</span> <span class="o">=</span> <span class="n">notop</span>
<span class="o">...</span>
<span class="o">...</span>             <span class="n">fnew</span> <span class="o">=</span> <span class="n">FST</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;_.__class__ </span><span class="si">{</span><span class="n">op</span><span class="si">}</span><span class="s1"> _&#39;</span><span class="p">)</span>
<span class="o">...</span>
<span class="o">...</span>             <span class="n">fnew</span><span class="o">.</span><span class="n">left</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">ftest</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
<span class="o">...</span>             <span class="n">fnew</span><span class="o">.</span><span class="n">comparators</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">ftype</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
<span class="o">...</span>
<span class="o">...</span>             <span class="k">if</span> <span class="n">fparent</span><span class="o">.</span><span class="n">is_NamedExpr</span><span class="p">:</span>  <span class="c1"># be nice and parenthesize ourselves here</span>
<span class="o">...</span>                 <span class="n">fnew</span><span class="o">.</span><span class="n">par</span><span class="p">()</span>  <span class="c1"># we know we are the .value</span>
<span class="o">...</span>
<span class="o">...</span>             <span class="n">f</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">fnew</span><span class="p">,</span> <span class="n">pars</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># preserve our own pars if present</span>
<span class="o">...</span>
<span class="o">...</span>     <span class="k">return</span> <span class="n">fst</span><span class="o">.</span><span class="n">src</span>
</code></pre>
</div>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">src</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">... def is_valid_target(asts: AST | list[AST]) -&gt; bool:</span>
<span class="s2">...     </span><span class="se">\&quot;\&quot;\&quot;</span><span class="s2">Check if `asts` is a valid target for `Assign` or `For`</span>
<span class="s2">...     operations. Must be `Name`, `Attribute`, `Subscript`</span>
<span class="s2">...     and / or possibly nested `Starred`, `Tuple` and `List`.</span><span class="se">\&quot;\&quot;\&quot;</span>
<span class="s2">...</span>
<span class="s2">...     stack = [asts] if isinstance(asts, AST) else list(asts)</span>
<span class="s2">...</span>
<span class="s2">...     while stack:</span>
<span class="s2">...         if isinstance(a := stack.pop(), (Tuple, List)):</span>
<span class="s2">...             stack.extend(a.elts)</span>
<span class="s2">...         elif isinstance(a, Starred):</span>
<span class="s2">...             stack.append(a.value)</span>
<span class="s2">...         elif not isinstance(a, (Name, Attribute, Subscript)):</span>
<span class="s2">...             return False</span>
<span class="s2">...</span>
<span class="s2">...     return True</span>
<span class="s2">... &quot;&quot;&quot;</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</code></pre>
</div>

<p>Original:</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">pprint</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">is_valid_target</span><span class="p">(</span><span class="n">asts</span><span class="p">:</span> <span class="n">AST</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="n">AST</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if `asts` is a valid target for `Assign` or `For`</span>
<span class="sd">    operations. Must be `Name`, `Attribute`, `Subscript`</span>
<span class="sd">    and / or possibly nested `Starred`, `Tuple` and `List`.&quot;&quot;&quot;</span>
 
    <span class="n">stack</span> <span class="o">=</span> <span class="p">[</span><span class="n">asts</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">asts</span><span class="p">,</span> <span class="n">AST</span><span class="p">)</span> <span class="k">else</span> <span class="nb">list</span><span class="p">(</span><span class="n">asts</span><span class="p">)</span>
 
    <span class="k">while</span> <span class="n">stack</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span> <span class="o">:=</span> <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">(),</span> <span class="p">(</span><span class="n">Tuple</span><span class="p">,</span> <span class="n">List</span><span class="p">)):</span>
            <span class="n">stack</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">elts</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">Starred</span><span class="p">):</span>
            <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="p">(</span><span class="n">Name</span><span class="p">,</span> <span class="n">Attribute</span><span class="p">,</span> <span class="n">Subscript</span><span class="p">)):</span>
            <span class="k">return</span> <span class="kc">False</span>
 
    <span class="k">return</span> <span class="kc">True</span>
</code></pre>
</div>

<p>Processed:</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">is_valid_target</span><span class="p">(</span><span class="n">asts</span><span class="p">:</span> <span class="n">AST</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="n">AST</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if `asts` is a valid target for `Assign` or `For`</span>
<span class="sd">    operations. Must be `Name`, `Attribute`, `Subscript`</span>
<span class="sd">    and / or possibly nested `Starred`, `Tuple` and `List`.&quot;&quot;&quot;</span>
 
    <span class="n">stack</span> <span class="o">=</span> <span class="p">[</span><span class="n">asts</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">asts</span><span class="p">,</span> <span class="n">AST</span><span class="p">)</span> <span class="k">else</span> <span class="nb">list</span><span class="p">(</span><span class="n">asts</span><span class="p">)</span>
 
    <span class="k">while</span> <span class="n">stack</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="o">:=</span> <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">())</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">in</span> <span class="p">(</span><span class="n">Tuple</span><span class="p">,</span> <span class="n">List</span><span class="p">):</span>
            <span class="n">stack</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">elts</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">a</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">is</span> <span class="n">Starred</span><span class="p">:</span>
            <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">a</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">Name</span><span class="p">,</span> <span class="n">Attribute</span><span class="p">,</span> <span class="n">Subscript</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
 
    <span class="k">return</span> <span class="kc">True</span>
</code></pre>
</div>

<h2 id="squash-nested-withs">Squash nested <code>with</code>s</h2>

<p>Slice operations make this easy enough. We only do synchronous <code>with</code> here as you can't mix sync with async anyway. Yes
the alignment is ugly, it will eventually be done properly, first priority was functional correctness. The comment on
the <code>with ctx():</code> could be preserved explicitly but not doing it here, eventually will be automatic option.</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="k">def</span><span class="w"> </span><span class="nf">squash_nested_withs</span><span class="p">(</span><span class="n">src</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="o">...</span>     <span class="n">fst</span> <span class="o">=</span> <span class="n">FST</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;exec&#39;</span><span class="p">)</span>
<span class="o">...</span>
<span class="o">...</span>     <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fst</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">With</span><span class="p">):</span>  <span class="c1"># we only get With nodes</span>
<span class="o">...</span>         <span class="k">while</span> <span class="n">f</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">is_With</span><span class="p">:</span>  <span class="c1"># first child is another With</span>
<span class="o">...</span>             <span class="c1"># append child items to ours</span>
<span class="o">...</span>             <span class="n">f</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">trivia</span><span class="o">=</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
<span class="o">...</span>
<span class="o">...</span>             <span class="n">f</span><span class="o">.</span><span class="n">put_slice</span><span class="p">(</span>  <span class="c1"># copy child body into our own</span>
<span class="o">...</span>                 <span class="n">f</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_slice</span><span class="p">(</span><span class="n">trivia</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;all+&#39;</span><span class="p">,</span> <span class="s1">&#39;block&#39;</span><span class="p">),</span> <span class="n">cut</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<span class="o">...</span>                 <span class="n">trivia</span><span class="o">=</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
<span class="o">...</span>             <span class="p">)</span>
<span class="o">...</span>
<span class="o">...</span>     <span class="k">return</span> <span class="n">fst</span><span class="o">.</span><span class="n">src</span>
</code></pre>
</div>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">src</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">... # with comment</span>
<span class="s2">... with open(a) as f:</span>
<span class="s2">...     with (</span>
<span class="s2">...         lock1,  # first lock</span>
<span class="s2">...         func() as lock2,  # this gets preserved</span>
<span class="s2">...     ):</span>
<span class="s2">...         with ctx():  # this does not belong to ctx()</span>
<span class="s2">...             # body comment</span>
<span class="s2">...             pass</span>
<span class="s2">...             # end body comment</span>
<span class="s2">...</span>
<span class="s2">... # post-with comment</span>
<span class="s2">... &quot;&quot;&quot;</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</code></pre>
</div>

<p>Original:</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">pprint</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
<span class="c1"># with comment</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="k">with</span> <span class="p">(</span>
        <span class="n">lock1</span><span class="p">,</span>  <span class="c1"># first lock</span>
        <span class="n">func</span><span class="p">()</span> <span class="k">as</span> <span class="n">lock2</span><span class="p">,</span>  <span class="c1"># this gets preserved</span>
    <span class="p">):</span>
        <span class="k">with</span> <span class="n">ctx</span><span class="p">():</span>  <span class="c1"># this does not belong to ctx()</span>
            <span class="c1"># body comment</span>
            <span class="k">pass</span>
            <span class="c1"># end body comment</span>
 
<span class="c1"># post-with comment</span>
</code></pre>
</div>

<p>Processed:</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">pprint</span><span class="p">(</span><span class="n">squash_nested_withs</span><span class="p">(</span><span class="n">src</span><span class="p">))</span>
<span class="c1"># with comment</span>
<span class="k">with</span> <span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">,</span>
     <span class="n">lock1</span><span class="p">,</span>  <span class="c1"># first lock</span>
     <span class="n">func</span><span class="p">()</span> <span class="k">as</span> <span class="n">lock2</span><span class="p">,</span>  <span class="c1"># this gets preserved</span>
     <span class="n">ctx</span><span class="p">()</span>
     <span class="p">):</span>
    <span class="c1"># body comment</span>
    <span class="k">pass</span>
    <span class="c1"># end body comment</span>
 
<span class="c1"># post-with comment</span>
</code></pre>
</div>

<h2 id="add-decorator-to-class-methods">Add decorator to class methods</h2>

<p>This one is very simple, we just want to add our own decorator to all class methods, not normal functions, with the
constraint that it be as close to the function as possible but not after a <code>@contextmanager</code>.</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="k">def</span><span class="w"> </span><span class="nf">insert_decorator_to_class_methods</span><span class="p">(</span><span class="n">src</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="o">...</span>     <span class="n">fst</span> <span class="o">=</span> <span class="n">FST</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;exec&#39;</span><span class="p">)</span>
<span class="o">...</span>
<span class="o">...</span>     <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fst</span><span class="o">.</span><span class="n">walk</span><span class="p">({</span><span class="n">FunctionDef</span><span class="p">,</span> <span class="n">AsyncFunctionDef</span><span class="p">}):</span>
<span class="o">...</span>         <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">is_ClassDef</span><span class="p">:</span>
<span class="o">...</span>             <span class="k">if</span> <span class="nb">any</span><span class="p">((</span><span class="n">deco</span> <span class="o">:=</span> <span class="n">d</span><span class="p">)</span><span class="o">.</span><span class="n">is_Name</span> <span class="ow">and</span> <span class="n">d</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="s1">&#39;contextmanager&#39;</span>
<span class="o">...</span>                    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">decorator_list</span><span class="p">):</span>
<span class="o">...</span>                 <span class="n">idx</span> <span class="o">=</span> <span class="n">deco</span><span class="o">.</span><span class="n">pfield</span><span class="o">.</span><span class="n">idx</span>
<span class="o">...</span>             <span class="k">else</span><span class="p">:</span>
<span class="o">...</span>                 <span class="n">idx</span> <span class="o">=</span> <span class="s1">&#39;end&#39;</span>
<span class="o">...</span>
<span class="o">...</span>             <span class="n">f</span><span class="o">.</span><span class="n">decorator_list</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="s1">&#39;@our_decorator&#39;</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">trivia</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="o">...</span>
<span class="o">...</span>     <span class="k">return</span> <span class="n">fst</span><span class="o">.</span><span class="n">src</span>
</code></pre>
</div>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">src</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">... def normal_function():</span>
<span class="s2">...     ...</span>
<span class="s2">...</span>
<span class="s2">... class SomeClass:</span>
<span class="s2">...     @staticmethod</span>
<span class="s2">...     def get_options() -&gt; dict[str, Any]:</span>
<span class="s2">...         ...</span>
<span class="s2">...</span>
<span class="s2">...     # class comment</span>
<span class="s2">...     @classmethod</span>
<span class="s2">...     def get_cls_option(option: str, options: Mapping[str, Any] = </span><span class="si">{}</span><span class="s2">) -&gt; object:</span>
<span class="s2">...         ...</span>
<span class="s2">...</span>
<span class="s2">...     # another class comment</span>
<span class="s2">...     async def set_async_inst_options(**options) -&gt; dict[str, Any]:</span>
<span class="s2">...         ...</span>
<span class="s2">...</span>
<span class="s2">...     @ \</span>
<span class="s2">... staticmethod</span>
<span class="s2">...     # intentionally screwy</span>
<span class="s2">...     @ (</span>
<span class="s2">...         contextmanager</span>
<span class="s2">...     )</span>
<span class="s2">...     def options(**options) -&gt; Iterator[dict[str, Any]]:</span>
<span class="s2">...         ...</span>
<span class="s2">... &quot;&quot;&quot;</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</code></pre>
</div>

<p>Original:</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">pprint</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">normal_function</span><span class="p">():</span>
    <span class="o">...</span>
 
<span class="k">class</span><span class="w"> </span><span class="nc">SomeClass</span><span class="p">:</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_options</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="o">...</span>
 
    <span class="c1"># class comment</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_cls_option</span><span class="p">(</span><span class="n">option</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">options</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{})</span> <span class="o">-&gt;</span> <span class="nb">object</span><span class="p">:</span>
        <span class="o">...</span>
 
    <span class="c1"># another class comment</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">set_async_inst_options</span><span class="p">(</span><span class="o">**</span><span class="n">options</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="o">...</span>
 
    <span class="o">@</span> \
<span class="nb">staticmethod</span>
    <span class="c1"># intentionally screwy</span>
    <span class="o">@</span> <span class="p">(</span>
        <span class="n">contextmanager</span>
    <span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">options</span><span class="p">(</span><span class="o">**</span><span class="n">options</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="o">...</span>
</code></pre>
</div>

<p>Processed:</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">pprint</span><span class="p">(</span><span class="n">insert_decorator_to_class_methods</span><span class="p">(</span><span class="n">src</span><span class="p">))</span>
<span class="k">def</span><span class="w"> </span><span class="nf">normal_function</span><span class="p">():</span>
    <span class="o">...</span>
 
<span class="k">class</span><span class="w"> </span><span class="nc">SomeClass</span><span class="p">:</span>
    <span class="nd">@staticmethod</span>
    <span class="nd">@our_decorator</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_options</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="o">...</span>
 
    <span class="c1"># class comment</span>
    <span class="nd">@classmethod</span>
    <span class="nd">@our_decorator</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_cls_option</span><span class="p">(</span><span class="n">option</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">options</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{})</span> <span class="o">-&gt;</span> <span class="nb">object</span><span class="p">:</span>
        <span class="o">...</span>
 
    <span class="c1"># another class comment</span>
    <span class="nd">@our_decorator</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">set_async_inst_options</span><span class="p">(</span><span class="o">**</span><span class="n">options</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="o">...</span>
 
    <span class="o">@</span> \
<span class="nb">staticmethod</span>
    <span class="c1"># intentionally screwy</span>
    <span class="nd">@our_decorator</span>
    <span class="o">@</span> <span class="p">(</span>
        <span class="n">contextmanager</span>
    <span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">options</span><span class="p">(</span><span class="o">**</span><span class="n">options</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="o">...</span>
</code></pre>
</div>

<h2 id="comprehension-to-loop">Comprehension to loop</h2>

<p>We build up a body and replace the original comprehension <code>Assign</code> statement with the new statements.</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="k">def</span><span class="w"> </span><span class="nf">list_comprehensions_to_loops</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
<span class="o">...</span>     <span class="n">fst</span> <span class="o">=</span> <span class="n">FST</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;exec&#39;</span><span class="p">)</span>
<span class="o">...</span>
<span class="o">...</span>     <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fst</span><span class="o">.</span><span class="n">walk</span><span class="p">():</span>
<span class="o">...</span>         <span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">is_Assign</span>  <span class="c1"># to show we can check here instead of passing to walk()</span>
<span class="o">...</span>             <span class="ow">and</span> <span class="n">f</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">is_ListComp</span>
<span class="o">...</span>             <span class="ow">and</span> <span class="n">f</span><span class="o">.</span><span class="n">targets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">is_Name</span>
<span class="o">...</span>             <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">targets</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
<span class="o">...</span>         <span class="p">):</span>
<span class="o">...</span>             <span class="n">var</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">targets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">id</span>
<span class="o">...</span>             <span class="n">fcomp</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">value</span>
<span class="o">...</span>             <span class="n">fcur</span> <span class="o">=</span> <span class="n">ftop</span> <span class="o">=</span> <span class="n">FST</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s1"> = []</span><span class="se">\n</span><span class="s1">_&#39;</span><span class="p">,</span> <span class="s1">&#39;exec&#39;</span><span class="p">)</span>
<span class="o">...</span>             <span class="c1"># the `_` will become first `for`</span>
<span class="o">...</span>
<span class="o">...</span>             <span class="k">for</span> <span class="n">fgen</span> <span class="ow">in</span> <span class="n">fcomp</span><span class="o">.</span><span class="n">generators</span><span class="p">:</span>
<span class="o">...</span>                 <span class="n">ffor</span> <span class="o">=</span> <span class="n">FST</span><span class="p">(</span><span class="s1">&#39;for _ in _:</span><span class="se">\n</span><span class="s1">    _&#39;</span><span class="p">)</span>  <span class="c1"># for loop, just copy the source</span>
<span class="o">...</span>                 <span class="n">ffor</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="n">fgen</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="o">...</span>                 <span class="n">ffor</span><span class="o">.</span><span class="n">iter</span> <span class="o">=</span> <span class="n">fgen</span><span class="o">.</span><span class="n">iter</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="o">...</span>
<span class="o">...</span>                 <span class="n">fcur</span> <span class="o">=</span> <span class="n">fcur</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">ffor</span><span class="p">)</span>
<span class="o">...</span>                 <span class="n">fifs</span> <span class="o">=</span> <span class="n">fgen</span><span class="o">.</span><span class="n">ifs</span>
<span class="o">...</span>                 <span class="n">nifs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fifs</span><span class="p">)</span>
<span class="o">...</span>
<span class="o">...</span>                 <span class="k">if</span> <span class="n">nifs</span><span class="p">:</span>  <span class="c1"># if no ifs then no test</span>
<span class="o">...</span>                     <span class="k">if</span> <span class="n">nifs</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># if single test then just use that</span>
<span class="o">...</span>                         <span class="n">ftest</span> <span class="o">=</span> <span class="n">fifs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="o">...</span>
<span class="o">...</span>                     <span class="k">else</span><span class="p">:</span>  <span class="c1"># if multiple then join with `and`</span>
<span class="o">...</span>                         <span class="n">ftest</span> <span class="o">=</span> <span class="n">FST</span><span class="p">(</span><span class="s1">&#39; and &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;_&#39;</span> <span class="o">*</span> <span class="n">nifs</span><span class="p">))</span>
<span class="o">...</span>
<span class="o">...</span>                         <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">fif</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fifs</span><span class="p">):</span>
<span class="o">...</span>                             <span class="n">ftest</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">fif</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="o">...</span>
<span class="o">...</span>                     <span class="n">fifstmt</span> <span class="o">=</span> <span class="n">FST</span><span class="p">(</span><span class="s1">&#39;if _:</span><span class="se">\n</span><span class="s1">    _&#39;</span><span class="p">)</span>
<span class="o">...</span>                     <span class="n">fifstmt</span><span class="o">.</span><span class="n">test</span> <span class="o">=</span> <span class="n">ftest</span>
<span class="o">...</span>
<span class="o">...</span>                     <span class="n">fcur</span> <span class="o">=</span> <span class="n">fcur</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">fifstmt</span><span class="p">)</span>
<span class="o">...</span>
<span class="o">...</span>             <span class="c1"># the ffor is the last one processed above (the innermost)</span>
<span class="o">...</span>             <span class="n">fcur</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s1">.append(</span><span class="si">{</span><span class="n">fcomp</span><span class="o">.</span><span class="n">elt</span><span class="o">.</span><span class="n">own_src</span><span class="p">()</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
<span class="o">...</span>
<span class="o">...</span>             <span class="n">f</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
<span class="o">...</span>                 <span class="n">ftop</span><span class="p">,</span>
<span class="o">...</span>                 <span class="n">one</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># this allows to replace a single element with multiple</span>
<span class="o">...</span>                 <span class="n">trivia</span><span class="o">=</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
<span class="o">...</span>             <span class="p">)</span>
<span class="o">...</span>
<span class="o">...</span>     <span class="k">return</span> <span class="n">fst</span><span class="o">.</span><span class="n">src</span>
</code></pre>
</div>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">src</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">... def f(k):</span>
<span class="s2">...     # safe comment</span>
<span class="s2">...     clean = [i for i in k]</span>
<span class="s2">...</span>
<span class="s2">...     # happy comment</span>
<span class="s2">...     messy = [</span>
<span class="s2">...         ( i )  # weird pars</span>
<span class="s2">...         for (</span>
<span class="s2">...             j</span>
<span class="s2">...         ) in k  # outer loop</span>
<span class="s2">...         if</span>
<span class="s2">...         j  # misc comment</span>
<span class="s2">...         and not validate(j)</span>
<span class="s2">...         for i in j  # inner loop</span>
<span class="s2">...         if i</span>
<span class="s2">...         if validate(i)</span>
<span class="s2">...     ]</span>
<span class="s2">...     # silly comment</span>
<span class="s2">...</span>
<span class="s2">...     return clean + messy</span>
<span class="s2">... &quot;&quot;&quot;</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</code></pre>
</div>

<p>Original:</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">pprint</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">f</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
    <span class="c1"># safe comment</span>
    <span class="n">clean</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">k</span><span class="p">]</span>
 
    <span class="c1"># happy comment</span>
    <span class="n">messy</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span> <span class="n">i</span> <span class="p">)</span>  <span class="c1"># weird pars</span>
        <span class="k">for</span> <span class="p">(</span>
            <span class="n">j</span>
        <span class="p">)</span> <span class="ow">in</span> <span class="n">k</span>  <span class="c1"># outer loop</span>
        <span class="k">if</span>
        <span class="n">j</span>  <span class="c1"># misc comment</span>
        <span class="ow">and</span> <span class="ow">not</span> <span class="n">validate</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">j</span>  <span class="c1"># inner loop</span>
        <span class="k">if</span> <span class="n">i</span>
        <span class="k">if</span> <span class="n">validate</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="c1"># silly comment</span>
 
    <span class="k">return</span> <span class="n">clean</span> <span class="o">+</span> <span class="n">messy</span>
</code></pre>
</div>

<p>Processed:</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">pprint</span><span class="p">(</span><span class="n">list_comprehensions_to_loops</span><span class="p">(</span><span class="n">src</span><span class="p">))</span>
<span class="k">def</span><span class="w"> </span><span class="nf">f</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
    <span class="c1"># safe comment</span>
    <span class="n">clean</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">k</span><span class="p">:</span>
        <span class="n">clean</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
 
    <span class="c1"># happy comment</span>
    <span class="n">messy</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">k</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">j</span>  <span class="c1"># misc comment</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="n">validate</span><span class="p">(</span><span class="n">j</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">j</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span> <span class="ow">and</span> <span class="n">validate</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
                    <span class="n">messy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="c1"># silly comment</span>
 
    <span class="k">return</span> <span class="n">clean</span> <span class="o">+</span> <span class="n">messy</span>
</code></pre>
</div>

<h2 id="align-equals">Align equals</h2>

<p>This is just here to show pure source modification without messing with the actual structure. It just walks everything
and stores all <code>Assign</code> nodes and any block of two or more nodes which start on consequtive lines and at the same column
get aligned. All the source put function does is offset <code>AST</code> node locations for source change. Same column is used as
proxy for verifying same parent.</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="k">def</span><span class="w"> </span><span class="nf">align_equals</span><span class="p">(</span><span class="n">fst</span><span class="p">):</span>
<span class="o">...</span>     <span class="n">flast</span> <span class="o">=</span> <span class="kc">None</span>
<span class="o">...</span>     <span class="n">blocks</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># [[feq1, feq2, ...], [feq1, ...], ...]</span>
<span class="o">...</span>
<span class="o">...</span>     <span class="c1"># first we build up list of contiguous Assign nodes</span>
<span class="o">...</span>     <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fst</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">Assign</span><span class="p">):</span>
<span class="o">...</span>         <span class="k">if</span> <span class="ow">not</span> <span class="n">flast</span> <span class="ow">or</span> <span class="n">f</span><span class="o">.</span><span class="n">col</span> <span class="o">!=</span> <span class="n">flast</span><span class="o">.</span><span class="n">col</span> <span class="ow">or</span> <span class="n">f</span><span class="o">.</span><span class="n">ln</span> <span class="o">!=</span> <span class="n">flast</span><span class="o">.</span><span class="n">ln</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
<span class="o">...</span>             <span class="n">blocks</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
<span class="o">...</span>
<span class="o">...</span>         <span class="n">blocks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flast</span> <span class="o">:=</span> <span class="n">f</span><span class="p">)</span>
<span class="o">...</span>
<span class="o">...</span>     <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">blocks</span><span class="p">:</span>
<span class="o">...</span>         <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">block</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
<span class="o">...</span>             <span class="n">eq_col</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">targets</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">pars</span><span class="p">()</span><span class="o">.</span><span class="n">end_col</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">block</span><span class="p">)</span>
<span class="o">...</span>
<span class="o">...</span>             <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">block</span><span class="p">:</span>
<span class="o">...</span>                 <span class="c1"># we know this is all on one line by how we constructed it</span>
<span class="o">...</span>                 <span class="n">ln</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">end_col</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">targets</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">pars</span><span class="p">()</span>
<span class="o">...</span>                 <span class="n">eq_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="s2">&quot; &quot;</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">eq_col</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">end_col</span><span class="p">)</span><span class="si">}</span><span class="s1"> = &#39;</span>
<span class="o">...</span>
<span class="o">...</span>                 <span class="n">f</span><span class="o">.</span><span class="n">put_src</span><span class="p">(</span><span class="n">eq_str</span><span class="p">,</span> <span class="n">ln</span><span class="p">,</span> <span class="n">end_col</span><span class="p">,</span> <span class="n">ln</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">pars</span><span class="p">()</span><span class="o">.</span><span class="n">col</span><span class="p">,</span> <span class="s1">&#39;offset&#39;</span><span class="p">)</span>
</code></pre>
</div>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">src</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">... a = 1</span>
<span class="s2">... this = that</span>
<span class="s2">... whatever[f].a   = &quot;YAY!&quot;</span>
<span class="s2">...</span>
<span class="s2">... on_multiple_lines = (</span>
<span class="s2">...     1, 2)</span>
<span class="s2">... we_dont_align = None</span>
<span class="s2">...</span>
<span class="s2">... ASTS_LEAF_FUNCDEF = {FunctionDef, AsyncFunctionDef}</span>
<span class="s2">... ASTS_LEAF_DEF = ASTS_LEAF_FUNCDEF | </span><span class="si">{ClassDef}</span>
<span class="s2">... ASTS_LEAF_DEF_OR_MOD = ASTS_LEAF_DEF | ASTS_LEAF_MOD</span>
<span class="s2">... ASTS_LEAF_FOR = {For, AsyncFor}</span>
<span class="s2">... ASTS_LEAF_WITH = {With, AsyncWith}</span>
<span class="s2">... ASTS_LEAF_TRY = {Try, TryStar}</span>
<span class="s2">... ASTS_LEAF_IMPORT = {Import, ImportFrom}</span>
<span class="s2">... &quot;&quot;&quot;</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</code></pre>
</div>

<p>Original:</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">pprint</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
<span class="n">a</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">this</span> <span class="o">=</span> <span class="n">that</span>
<span class="n">whatever</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">a</span>   <span class="o">=</span> <span class="s2">&quot;YAY!&quot;</span>
 
<span class="n">on_multiple_lines</span> <span class="o">=</span> <span class="p">(</span>
    <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">we_dont_align</span> <span class="o">=</span> <span class="kc">None</span>
 
<span class="n">ASTS_LEAF_FUNCDEF</span> <span class="o">=</span> <span class="p">{</span><span class="n">FunctionDef</span><span class="p">,</span> <span class="n">AsyncFunctionDef</span><span class="p">}</span>
<span class="n">ASTS_LEAF_DEF</span> <span class="o">=</span> <span class="n">ASTS_LEAF_FUNCDEF</span> <span class="o">|</span> <span class="p">{</span><span class="n">ClassDef</span><span class="p">}</span>
<span class="n">ASTS_LEAF_DEF_OR_MOD</span> <span class="o">=</span> <span class="n">ASTS_LEAF_DEF</span> <span class="o">|</span> <span class="n">ASTS_LEAF_MOD</span>
<span class="n">ASTS_LEAF_FOR</span> <span class="o">=</span> <span class="p">{</span><span class="n">For</span><span class="p">,</span> <span class="n">AsyncFor</span><span class="p">}</span>
<span class="n">ASTS_LEAF_WITH</span> <span class="o">=</span> <span class="p">{</span><span class="n">With</span><span class="p">,</span> <span class="n">AsyncWith</span><span class="p">}</span>
<span class="n">ASTS_LEAF_TRY</span> <span class="o">=</span> <span class="p">{</span><span class="n">Try</span><span class="p">,</span> <span class="n">TryStar</span><span class="p">}</span>
<span class="n">ASTS_LEAF_IMPORT</span> <span class="o">=</span> <span class="p">{</span><span class="n">Import</span><span class="p">,</span> <span class="n">ImportFrom</span><span class="p">}</span>
</code></pre>
</div>

<p>Processed:</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">fst</span> <span class="o">=</span> <span class="n">FST</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;exec&#39;</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">align_equals</span><span class="p">(</span><span class="n">fst</span><span class="p">)</span>  <span class="c1"># we pass as an FST so we can `.dump()` below</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">pprint</span><span class="p">(</span><span class="n">fst</span><span class="o">.</span><span class="n">src</span><span class="p">)</span>
<span class="n">a</span>             <span class="o">=</span> <span class="mi">1</span>
<span class="n">this</span>          <span class="o">=</span> <span class="n">that</span>
<span class="n">whatever</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="s2">&quot;YAY!&quot;</span>
 
<span class="n">on_multiple_lines</span> <span class="o">=</span> <span class="p">(</span>
    <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">we_dont_align</span> <span class="o">=</span> <span class="kc">None</span>
 
<span class="n">ASTS_LEAF_FUNCDEF</span>    <span class="o">=</span> <span class="p">{</span><span class="n">FunctionDef</span><span class="p">,</span> <span class="n">AsyncFunctionDef</span><span class="p">}</span>
<span class="n">ASTS_LEAF_DEF</span>        <span class="o">=</span> <span class="n">ASTS_LEAF_FUNCDEF</span> <span class="o">|</span> <span class="p">{</span><span class="n">ClassDef</span><span class="p">}</span>
<span class="n">ASTS_LEAF_DEF_OR_MOD</span> <span class="o">=</span> <span class="n">ASTS_LEAF_DEF</span> <span class="o">|</span> <span class="n">ASTS_LEAF_MOD</span>
<span class="n">ASTS_LEAF_FOR</span>        <span class="o">=</span> <span class="p">{</span><span class="n">For</span><span class="p">,</span> <span class="n">AsyncFor</span><span class="p">}</span>
<span class="n">ASTS_LEAF_WITH</span>       <span class="o">=</span> <span class="p">{</span><span class="n">With</span><span class="p">,</span> <span class="n">AsyncWith</span><span class="p">}</span>
<span class="n">ASTS_LEAF_TRY</span>        <span class="o">=</span> <span class="p">{</span><span class="n">Try</span><span class="p">,</span> <span class="n">TryStar</span><span class="p">}</span>
<span class="n">ASTS_LEAF_IMPORT</span>     <span class="o">=</span> <span class="p">{</span><span class="n">Import</span><span class="p">,</span> <span class="n">ImportFrom</span><span class="p">}</span>
</code></pre>
</div>

<p>Here we do a quick dump of the first three statements to show that all the locations of the nodes were offset properly.</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">_</span> <span class="o">=</span> <span class="n">fst</span><span class="o">.</span><span class="n">body</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="s1">&#39;stmt&#39;</span><span class="p">)</span>
<span class="n">Module</span> <span class="o">-</span> <span class="n">ROOT</span> <span class="mi">0</span><span class="p">,</span><span class="mf">0..2</span><span class="p">,</span><span class="mi">22</span>
  <span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
<span class="mi">0</span><span class="p">:</span> <span class="n">a</span>             <span class="o">=</span> <span class="mi">1</span>
   <span class="mi">0</span><span class="p">]</span> <span class="n">Assign</span> <span class="o">-</span> <span class="mi">0</span><span class="p">,</span><span class="mf">0..0</span><span class="p">,</span><span class="mi">17</span>
     <span class="o">.</span><span class="n">targets</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
      <span class="mi">0</span><span class="p">]</span> <span class="n">Name</span> <span class="s1">&#39;a&#39;</span> <span class="n">Store</span> <span class="o">-</span> <span class="mi">0</span><span class="p">,</span><span class="mf">0..0</span><span class="p">,</span><span class="mi">1</span>
     <span class="o">.</span><span class="n">value</span> <span class="n">Constant</span> <span class="mi">1</span> <span class="o">-</span> <span class="mi">0</span><span class="p">,</span><span class="mf">16..0</span><span class="p">,</span><span class="mi">17</span>
<span class="mi">1</span><span class="p">:</span> <span class="n">this</span>          <span class="o">=</span> <span class="n">that</span>
   <span class="mi">1</span><span class="p">]</span> <span class="n">Assign</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span><span class="mf">0..1</span><span class="p">,</span><span class="mi">20</span>
     <span class="o">.</span><span class="n">targets</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
      <span class="mi">0</span><span class="p">]</span> <span class="n">Name</span> <span class="s1">&#39;this&#39;</span> <span class="n">Store</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span><span class="mf">0..1</span><span class="p">,</span><span class="mi">4</span>
     <span class="o">.</span><span class="n">value</span> <span class="n">Name</span> <span class="s1">&#39;that&#39;</span> <span class="n">Load</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span><span class="mf">16..1</span><span class="p">,</span><span class="mi">20</span>
<span class="mi">2</span><span class="p">:</span> <span class="n">whatever</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="s2">&quot;YAY!&quot;</span>
   <span class="mi">2</span><span class="p">]</span> <span class="n">Assign</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span><span class="mf">0..2</span><span class="p">,</span><span class="mi">22</span>
     <span class="o">.</span><span class="n">targets</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
      <span class="mi">0</span><span class="p">]</span> <span class="n">Attribute</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span><span class="mf">0..2</span><span class="p">,</span><span class="mi">13</span>
        <span class="o">.</span><span class="n">value</span> <span class="n">Subscript</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span><span class="mf">0..2</span><span class="p">,</span><span class="mi">11</span>
          <span class="o">.</span><span class="n">value</span> <span class="n">Name</span> <span class="s1">&#39;whatever&#39;</span> <span class="n">Load</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span><span class="mf">0..2</span><span class="p">,</span><span class="mi">8</span>
          <span class="o">.</span><span class="n">slice</span> <span class="n">Name</span> <span class="s1">&#39;f&#39;</span> <span class="n">Load</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span><span class="mf">9..2</span><span class="p">,</span><span class="mi">10</span>
          <span class="o">.</span><span class="n">ctx</span> <span class="n">Load</span>
        <span class="o">.</span><span class="n">attr</span> <span class="s1">&#39;a&#39;</span>
        <span class="o">.</span><span class="n">ctx</span> <span class="n">Store</span>
     <span class="o">.</span><span class="n">value</span> <span class="n">Constant</span> <span class="s1">&#39;YAY!&#39;</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span><span class="mf">16..2</span><span class="p">,</span><span class="mi">22</span>
</code></pre>
</div>

<h2 id="make-all-f-strings-self-documenting">Make all f-strings self-documenting</h2>

<p><strong>Note:</strong> This example in particular is Python 3.12+ because of the comment in the multiline f-string. The function
itself will work mostly on lower version Pythons.</p>

<p>Suppose you just want to improve the debug logs by adding self-documenting debug strings to all f-strings, e.g.
<code>f"{var}"</code> into <code>f"{var=}"</code>. The example below shows how, though there is just one caveat to look out for if you want to
continue working with the <code>AST</code> tree:</p>

<p>The source is updated and all the node locations are fine, but the <code>put_src(..., action='offset')</code> only offsets node
locations and does not create the <code>AST</code> nodes for any new <code>Constant</code> strings due to the newly self-documenting
<code>FormattedValue</code> nodes. If you only care about source for output (like this example) then this is a non-issue. If you
need those nodes to continue working with an <code>AST</code> tree then you can do a <code>root.reparse()</code> after making all the changes,
or individual <code>reparse()</code> on each modified statement, or use <code>put_src(..., action='reparse')</code> for each individual
change, but that would be slower.</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="k">def</span><span class="w"> </span><span class="nf">self_document_fstring_expressions</span><span class="p">(</span><span class="n">src</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="o">...</span>     <span class="n">fst</span> <span class="o">=</span> <span class="n">FST</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;exec&#39;</span><span class="p">)</span>
<span class="o">...</span>
<span class="o">...</span>     <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fst</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">FormattedValue</span><span class="p">):</span>  <span class="c1"># could add Interpolation to do both</span>
<span class="o">...</span>         <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">end_ln</span><span class="p">,</span> <span class="n">end_col</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">pars</span><span class="p">()</span>  <span class="c1"># value end after parentheses</span>
<span class="o">...</span>
<span class="o">...</span>         <span class="c1"># hacky but valid way to check if &#39;=&#39; already there and not in comment</span>
<span class="o">...</span>         <span class="c1"># between the end of the expression and end of FormattedValue</span>
<span class="o">...</span>         <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">get_src</span><span class="p">(</span><span class="n">end_ln</span><span class="p">,</span> <span class="n">end_col</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">end_ln</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">end_col</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">as_lines</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="o">...</span>
<span class="o">...</span>         <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">):</span>
<span class="o">...</span>             <span class="c1"># insert the equals just after the expression</span>
<span class="o">...</span>             <span class="n">f</span><span class="o">.</span><span class="n">put_src</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="n">end_ln</span><span class="p">,</span> <span class="n">end_col</span><span class="p">,</span> <span class="n">end_ln</span><span class="p">,</span> <span class="n">end_col</span><span class="p">,</span> <span class="s1">&#39;offset&#39;</span><span class="p">)</span>
<span class="o">...</span>
<span class="o">...</span>     <span class="k">return</span> <span class="n">fst</span><span class="o">.</span><span class="n">src</span>
</code></pre>
</div>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">src</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">... f&#39;added here </span><span class="si">{a}</span><span class="s2">, and here { ( b ) }&#39;</span>
<span class="s2">...</span>
<span class="s2">... f&#39;not added here {c=}&#39;</span>
<span class="s2">...</span>
<span class="s2">... f</span><span class="se">\&quot;\&quot;\&quot;</span><span class="s2">{(  # =========================</span>
<span class="s2">...     d,  # commented out =, so added</span>
<span class="s2">... )}, {e</span>
<span class="s2">...     =} &lt;- not commented out so not added</span><span class="se">\&quot;\&quot;\&quot;</span>
<span class="s2">... &quot;&quot;&quot;</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</code></pre>
</div>

<p>Original:</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">pprint</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
<span class="sa">f</span><span class="s1">&#39;added here </span><span class="si">{</span><span class="n">a</span><span class="si">}</span><span class="s1">, and here </span><span class="si">{</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="si">}</span><span class="s1">&#39;</span>
 
<span class="sa">f</span><span class="s1">&#39;not added here </span><span class="si">{</span><span class="n">c</span><span class="si">=}</span><span class="s1">&#39;</span>
 
<span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span><span class="si">{</span><span class="p">(</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="o">=========================</span>
<span class="w">    </span><span class="n">d</span><span class="p">,</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="n">commented</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="o">=</span><span class="p">,</span><span class="w"> </span><span class="n">so</span><span class="w"> </span><span class="n">added</span>
<span class="p">)</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">e</span>
<span class="w">    </span><span class="si">=}</span><span class="s2"> &lt;- not commented out so not added&quot;&quot;&quot;</span>
</code></pre>
</div>

<p>Processed:</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="sa">f</span><span class="s1">&#39;added here </span><span class="si">{</span><span class="n">a</span><span class="si">=}</span><span class="s1">, and here </span><span class="si">{</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="p">)</span><span class="si">= }</span><span class="s1">&#39;</span>
 
<span class="sa">f</span><span class="s1">&#39;not added here </span><span class="si">{</span><span class="n">c</span><span class="si">=}</span><span class="s1">&#39;</span>
 
<span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span><span class="si">{</span><span class="p">(</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="o">=========================</span>
<span class="w">    </span><span class="n">d</span><span class="p">,</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="n">commented</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="o">=</span><span class="p">,</span><span class="w"> </span><span class="n">so</span><span class="w"> </span><span class="n">added</span>
<span class="p">)</span><span class="si">=}</span><span class="s2">, </span><span class="si">{</span><span class="n">e</span>
<span class="w">    </span><span class="si">=}</span><span class="s2"> &lt;- not commented out so not added&quot;&quot;&quot;</span>
</code></pre>
</div>

<h2 id="normalize-docstrings">Normalize docstrings</h2>

<p><code>get_docstr()</code> gives you a normal string and <code>put_docstr()</code> puts it with appropriate formatting for a docstring. In this
case we also pass <code>reput=True</code> because we specifically want it to remove and then put the docstring expression again so
that it precedes any comments. Otherwise it just replaces the docstring in the location where it currently is.</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="k">def</span><span class="w"> </span><span class="nf">normalize_docstrings</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
<span class="o">...</span>     <span class="n">fst</span> <span class="o">=</span> <span class="n">FST</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;exec&#39;</span><span class="p">)</span>
<span class="o">...</span>
<span class="o">...</span>     <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fst</span><span class="o">.</span><span class="n">walk</span><span class="p">():</span>
<span class="o">...</span>         <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">has_docstr</span><span class="p">:</span>
<span class="o">...</span>             <span class="n">f</span><span class="o">.</span><span class="n">put_docstr</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">get_docstr</span><span class="p">(),</span> <span class="n">reput</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="o">...</span>
<span class="o">...</span>     <span class="k">return</span> <span class="n">fst</span><span class="o">.</span><span class="n">src</span>
</code></pre>
</div>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">src</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">... class cls:</span>
<span class="s2">...     # docstr should be before this</span>
<span class="s2">...     &quot;Some</span><span class="se">\\</span><span class="s2">nunformatted</span><span class="se">\\</span><span class="s2">ndocstr.&quot;  # what is this?!?</span>
<span class="s2">...</span>
<span class="s2">...     def method(self):</span>
<span class="s2">...</span>
<span class="s2">...         </span><span class="se">\&quot;\&quot;\&quot;</span><span class="s2">I&#39;m not</span>
<span class="s2">...     even properly</span>
<span class="s2">... aligned!!! </span><span class="se">\\</span><span class="s2">U0001F92a</span>
<span class="s2">...         Or am I</span><span class="se">\\</span><span class="s2">x3f</span><span class="se">\&quot;\&quot;\&quot;</span>
<span class="s2">...         # comment</span>
<span class="s2">...</span>
<span class="s2">...         pass</span>
<span class="s2">... &quot;&quot;&quot;</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</code></pre>
</div>

<p>Original:</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">pprint</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">cls</span><span class="p">:</span>
    <span class="c1"># docstr should be before this</span>
    <span class="s2">&quot;Some</span><span class="se">\n</span><span class="s2">unformatted</span><span class="se">\n</span><span class="s2">docstr.&quot;</span>  <span class="c1"># what is this?!?</span>
 
    <span class="k">def</span><span class="w"> </span><span class="nf">method</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w"> </span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;I&#39;m not</span>
<span class="sd">    even properly</span>
<span class="sd">aligned!!! \U0001F92a</span>
<span class="sd">        Or am I\x3f&quot;&quot;&quot;</span>
        <span class="c1"># comment</span>
 
        <span class="k">pass</span>
</code></pre>
</div>

<p>Processed:</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">cls</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Some</span>
<span class="sd">    unformatted</span>
<span class="sd">    docstr.&quot;&quot;&quot;</span>
 
    <span class="c1"># docstr should be before this</span>
    <span class="c1"># what is this?!?</span>
 
    <span class="k">def</span><span class="w"> </span><span class="nf">method</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;I&#39;m not</span>
<span class="sd">        even properly</span>
<span class="sd">        aligned!!! 🤪</span>
<span class="sd">        Or am I?&quot;&quot;&quot;</span>
 
        <span class="c1"># comment</span>
 
        <span class="k">pass</span>
</code></pre>
</div>

<h2 id="reparenthesize-expressions">Reparenthesize expressions</h2>

<p>Parentheses are handled completely automatically normally and you can use this mechanism to clean up unnecessary
or ugly parenthesization. Yes we realize some unnecessary parenthesization may be dictated by the currently enforced
aesthetic paradigm of any given project. This is just to show proper functional parenthesization by <code><a href="../../fst.html">fst</a></code>.</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="k">def</span><span class="w"> </span><span class="nf">reparenthesize_simple</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
<span class="o">...</span>     <span class="n">fst</span> <span class="o">=</span> <span class="n">FST</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;exec&#39;</span><span class="p">)</span>
<span class="o">...</span>
<span class="o">...</span>     <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fst</span><span class="o">.</span><span class="n">walk</span><span class="p">():</span>
<span class="o">...</span>         <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_parenthesizable</span><span class="p">():</span>
<span class="o">...</span>             <span class="n">f</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
<span class="o">...</span>
<span class="o">...</span>     <span class="k">return</span> <span class="n">fst</span><span class="o">.</span><span class="n">src</span>
</code></pre>
</div>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">src</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">... (x * y) * (a + b)  # &quot;x * y&quot; doesn&#39;t need pars, &#39;a + b&#39; does</span>
<span class="s2">...</span>
<span class="s2">... (x * y) * z  # &quot;x * y&quot; is unpard because doesn&#39;t change tree structure</span>
<span class="s2">...</span>
<span class="s2">... x * (y * z)  # not unpard because would change structure (order of operations)</span>
<span class="s2">...</span>
<span class="s2">... a + ( (  (y) * (z)))  # nested pars cleaned up</span>
<span class="s2">...</span>
<span class="s2">... x * ( (  (y) * (z)))  # original pars normally left if needed, unless unpar() used</span>
<span class="s2">...</span>
<span class="s2">... if (</span>
<span class="s2">...     (a &lt;= b)</span>
<span class="s2">... ):  # not needed</span>
<span class="s2">...     return (a  # hello</span>
<span class="s2">...             &lt; b)  # needed for parsability</span>
<span class="s2">...</span>
<span class="s2">... match (&quot;a&quot;  # implicit string pars needed</span>
<span class="s2">...        &quot;b&quot;):</span>
<span class="s2">...     case ((1) | (a)):  # unnecessary pars</span>
<span class="s2">...         pass</span>
<span class="s2">...     case (a, b):  # MatchSequence node intrinsic pars are not removed</span>
<span class="s2">...         pass</span>
<span class="s2">...     case ( ( (a, b) ) ):  # but the unnecessary ones are</span>
<span class="s2">...         pass</span>
<span class="s2">... &quot;&quot;&quot;</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</code></pre>
</div>

<p>Original:</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">pprint</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
<span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">y</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span>  <span class="c1"># &quot;x * y&quot; doesn&#39;t need pars, &#39;a + b&#39; does</span>
 
<span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">y</span><span class="p">)</span> <span class="o">*</span> <span class="n">z</span>  <span class="c1"># &quot;x * y&quot; is unpard because doesn&#39;t change tree structure</span>
 
<span class="n">x</span> <span class="o">*</span> <span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="n">z</span><span class="p">)</span>  <span class="c1"># not unpard because would change structure (order of operations)</span>
 
<span class="n">a</span> <span class="o">+</span> <span class="p">(</span> <span class="p">(</span>  <span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">z</span><span class="p">)))</span>  <span class="c1"># nested pars cleaned up</span>
 
<span class="n">x</span> <span class="o">*</span> <span class="p">(</span> <span class="p">(</span>  <span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">z</span><span class="p">)))</span>  <span class="c1"># original pars normally left if needed, unless unpar() used</span>
 
<span class="k">if</span> <span class="p">(</span>
    <span class="p">(</span><span class="n">a</span> <span class="o">&lt;=</span> <span class="n">b</span><span class="p">)</span>
<span class="p">):</span>  <span class="c1"># not needed</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">a</span>  <span class="c1"># hello</span>
            <span class="o">&lt;</span> <span class="n">b</span><span class="p">)</span>  <span class="c1"># needed for parsability</span>
 
<span class="k">match</span> <span class="p">(</span><span class="s2">&quot;a&quot;</span>  <span class="c1"># implicit string pars needed</span>
       <span class="s2">&quot;b&quot;</span><span class="p">):</span>
    <span class="k">case</span> <span class="p">((</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">a</span><span class="p">)):</span>  <span class="c1"># unnecessary pars</span>
        <span class="k">pass</span>
    <span class="k">case</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>  <span class="c1"># MatchSequence node intrinsic pars are not removed</span>
        <span class="k">pass</span>
    <span class="k">case</span> <span class="p">(</span> <span class="p">(</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="p">)</span> <span class="p">):</span>  <span class="c1"># but the unnecessary ones are</span>
        <span class="k">pass</span>
</code></pre>
</div>

<p>Processed:</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">pprint</span><span class="p">(</span><span class="n">reparenthesize_simple</span><span class="p">(</span><span class="n">src</span><span class="p">))</span>
<span class="n">x</span> <span class="o">*</span> <span class="n">y</span> <span class="o">*</span> <span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span>  <span class="c1"># &quot;x * y&quot; doesn&#39;t need pars, &#39;a + b&#39; does</span>
 
<span class="n">x</span> <span class="o">*</span> <span class="n">y</span> <span class="o">*</span> <span class="n">z</span>  <span class="c1"># &quot;x * y&quot; is unpard because doesn&#39;t change tree structure</span>
 
<span class="n">x</span> <span class="o">*</span> <span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="n">z</span><span class="p">)</span>  <span class="c1"># not unpard because would change structure (order of operations)</span>
 
<span class="n">a</span> <span class="o">+</span> <span class="n">y</span> <span class="o">*</span> <span class="n">z</span>  <span class="c1"># nested pars cleaned up</span>
 
<span class="n">x</span> <span class="o">*</span> <span class="p">(</span> <span class="p">(</span>  <span class="n">y</span> <span class="o">*</span> <span class="n">z</span><span class="p">))</span>  <span class="c1"># original pars normally left if needed, unless unpar() used</span>
 
<span class="k">if</span> <span class="n">a</span> <span class="o">&lt;=</span> <span class="n">b</span><span class="p">:</span>  <span class="c1"># not needed</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">a</span>  <span class="c1"># hello</span>
            <span class="o">&lt;</span> <span class="n">b</span><span class="p">)</span>  <span class="c1"># needed for parsability</span>
 
<span class="k">match</span> <span class="p">(</span><span class="s2">&quot;a&quot;</span>  <span class="c1"># implicit string pars needed</span>
       <span class="s2">&quot;b&quot;</span><span class="p">):</span>
    <span class="k">case</span> <span class="mi">1</span> <span class="o">|</span> <span class="n">a</span><span class="p">:</span>  <span class="c1"># unnecessary pars</span>
        <span class="k">pass</span>
    <span class="k">case</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>  <span class="c1"># MatchSequence node intrinsic pars are not removed</span>
        <span class="k">pass</span>
    <span class="k">case</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>  <span class="c1"># but the unnecessary ones are</span>
        <span class="k">pass</span>
</code></pre>
</div>

<p>A slight tweak to the function to unparenthesize first will force reparenthesize of parentheses which are needed but may
not have been in normal locations to begin with.</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="k">def</span><span class="w"> </span><span class="nf">reparenthesize_full</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
<span class="o">...</span>     <span class="n">fst</span> <span class="o">=</span> <span class="n">FST</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;exec&#39;</span><span class="p">)</span>
<span class="o">...</span>
<span class="o">...</span>     <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fst</span><span class="o">.</span><span class="n">walk</span><span class="p">():</span>
<span class="o">...</span>         <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_parenthesizable</span><span class="p">():</span>
<span class="o">...</span>             <span class="n">f</span><span class="o">.</span><span class="n">unpar</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
<span class="o">...</span>
<span class="o">...</span>     <span class="k">return</span> <span class="n">fst</span><span class="o">.</span><span class="n">src</span>
</code></pre>
</div>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">pprint</span><span class="p">(</span><span class="n">reparenthesize_full</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">... a + ( (  (y) * (z)))  # nested pars cleaned up</span>
<span class="s2">...</span>
<span class="s2">... x * ( (  (y) * (z)))  # original pars normally left if needed, unless unpar() used</span>
<span class="s2">... &quot;&quot;&quot;</span><span class="o">.</span><span class="n">strip</span><span class="p">()))</span>
<span class="n">a</span> <span class="o">+</span> <span class="n">y</span> <span class="o">*</span> <span class="n">z</span>  <span class="c1"># nested pars cleaned up</span>
 
<span class="n">x</span> <span class="o">*</span> <span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="n">z</span><span class="p">)</span>  <span class="c1"># original pars normally left if needed, unless unpar() used</span>
</code></pre>
</div>

<h2 id="instrument-expressions">Instrument expressions</h2>

<p>Suppose there is an external library that overloaded some operators and there are problems and you want to log all the
operations (or do something else with them). This is the type of problem that <code><a href="../../fst.html">fst</a></code> was conceived to solve easily. The
instrumentation is ugly but is meant to show that all these nested manipulations maintain the correct working source.</p>

<p>Note that this instrumentation counts on the fact that the syntactic order of the children of these particular node
types is actually the order they will be evaluated in. This is not always the case, e.g. with the <code>IfExp</code> node the
middle gets evaluated first <code>THEN_THIS if FIRST_THIS else OR_THEN_THIS</code>.</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="k">def</span><span class="w"> </span><span class="nf">instrument_operations</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
<span class="o">...</span>     <span class="n">fst</span> <span class="o">=</span> <span class="n">FST</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;exec&#39;</span><span class="p">)</span>
<span class="o">...</span>
<span class="o">...</span>     <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fst</span><span class="o">.</span><span class="n">walk</span><span class="p">():</span>
<span class="o">...</span>         <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s1">&#39;_dirty&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>  <span class="c1"># did we generate this?</span>
<span class="o">...</span>             <span class="k">continue</span>
<span class="o">...</span>
<span class="o">...</span>         <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_BinOp</span><span class="p">:</span>
<span class="o">...</span>             <span class="n">fargs</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">left</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">right</span><span class="p">]</span>
<span class="o">...</span>         <span class="k">elif</span> <span class="n">f</span><span class="o">.</span><span class="n">is_UnaryOp</span><span class="p">:</span>
<span class="o">...</span>             <span class="n">fargs</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">operand</span><span class="p">]</span>
<span class="o">...</span>         <span class="k">elif</span> <span class="n">f</span><span class="o">.</span><span class="n">is_Compare</span><span class="p">:</span>
<span class="o">...</span>             <span class="n">fargs</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">left</span><span class="p">,</span> <span class="o">*</span><span class="n">f</span><span class="o">.</span><span class="n">comparators</span><span class="p">]</span>
<span class="o">...</span>         <span class="k">else</span><span class="p">:</span>
<span class="o">...</span>             <span class="k">continue</span>
<span class="o">...</span>
<span class="o">...</span>         <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">parents</span><span class="p">():</span>  <span class="c1"># make sure we don&#39;t overwrite vars in use by parent</span>
<span class="o">...</span>             <span class="k">if</span> <span class="p">(</span><span class="n">base</span> <span class="o">:=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="s1">&#39;_base_idx&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="o">...</span>                 <span class="k">break</span>
<span class="o">...</span>         <span class="k">else</span><span class="p">:</span>
<span class="o">...</span>             <span class="n">base</span> <span class="o">=</span> <span class="mi">0</span>
<span class="o">...</span>
<span class="o">...</span>         <span class="n">nargs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fargs</span><span class="p">)</span>
<span class="o">...</span>         <span class="n">ftmps</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">base</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nargs</span><span class="p">))</span>
<span class="o">...</span>         <span class="n">fsettmps</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">base</span><span class="si">}</span><span class="s1"> := _&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nargs</span><span class="p">))</span>
<span class="o">...</span>
<span class="o">...</span>         <span class="n">fnew</span> <span class="o">=</span> <span class="n">FST</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;(</span><span class="si">{</span><span class="n">fsettmps</span><span class="si">}</span><span class="s1">, log(</span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">src</span><span class="si">!r}</span><span class="s1">, </span><span class="si">{</span><span class="n">ftmps</span><span class="si">}</span><span class="s1">), _)[</span><span class="si">{</span><span class="n">nargs</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s1">]&#39;</span><span class="p">)</span>
<span class="o">...</span>         <span class="n">felts</span> <span class="o">=</span> <span class="n">fnew</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">elts</span>
<span class="o">...</span>
<span class="o">...</span>         <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nargs</span><span class="p">):</span>
<span class="o">...</span>             <span class="n">felts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">fargs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
<span class="o">...</span>             <span class="n">fargs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">base</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="o">...</span>
<span class="o">...</span>         <span class="n">fold</span> <span class="o">=</span> <span class="n">felts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>  <span class="c1"># put operation using temp vars</span>
<span class="o">...</span>         <span class="n">fnew</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">fnew</span><span class="p">)</span>
<span class="o">...</span>
<span class="o">...</span>         <span class="n">fold</span><span class="o">.</span><span class="n">_dirty</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># must set after the replace because FST may change</span>
<span class="o">...</span>         <span class="n">fnew</span><span class="o">.</span><span class="n">_base_idx</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">nargs</span> <span class="o">-</span> <span class="mi">1</span>  <span class="c1"># safe start idx for children to use</span>
<span class="o">...</span>
<span class="o">...</span>     <span class="k">return</span> <span class="n">fst</span><span class="o">.</span><span class="n">src</span>
</code></pre>
</div>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">src</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">... def shape_score(a, b, c, d):</span>
<span class="s2">...     x = (a * b) - -(c + d)</span>
<span class="s2">...     y = ~(a - c) + (b ^ d)</span>
<span class="s2">...     z = (x // (abs(y) or 1))</span>
<span class="s2">...</span>
<span class="s2">...     return (z &lt; 0) * -z + (z &gt;= 0) * +z</span>
<span class="s2">... &quot;&quot;&quot;</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</code></pre>
</div>

<p>Original:</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">pprint</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">shape_score</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="n">b</span><span class="p">)</span> <span class="o">-</span> <span class="o">-</span><span class="p">(</span><span class="n">c</span> <span class="o">+</span> <span class="n">d</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="n">a</span> <span class="o">-</span> <span class="n">c</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">b</span> <span class="o">^</span> <span class="n">d</span><span class="p">)</span>
    <span class="n">z</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">//</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">1</span><span class="p">))</span>
 
    <span class="k">return</span> <span class="p">(</span><span class="n">z</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="o">-</span><span class="n">z</span> <span class="o">+</span> <span class="p">(</span><span class="n">z</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="o">+</span><span class="n">z</span>
</code></pre>
</div>

<p>Processed:</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">pprint</span><span class="p">(</span><span class="n">inst</span> <span class="o">:=</span> <span class="n">instrument_operations</span><span class="p">(</span><span class="n">src</span><span class="p">))</span>
<span class="k">def</span><span class="w"> </span><span class="nf">shape_score</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">_0</span> <span class="o">:=</span> <span class="p">(</span><span class="n">_1</span> <span class="o">:=</span> <span class="n">a</span><span class="p">,</span> <span class="n">_2</span> <span class="o">:=</span> <span class="n">b</span><span class="p">,</span> <span class="n">log</span><span class="p">(</span><span class="s1">&#39;a * b&#39;</span><span class="p">,</span> <span class="n">_1</span><span class="p">,</span> <span class="n">_2</span><span class="p">),</span> <span class="n">_1</span> <span class="o">*</span> <span class="n">_2</span><span class="p">)[</span><span class="mi">3</span><span class="p">],</span> <span class="n">_1</span> <span class="o">:=</span> <span class="p">(</span><span class="n">_1</span> <span class="o">:=</span> <span class="p">(</span><span class="n">_1</span> <span class="o">:=</span> <span class="n">c</span><span class="p">,</span> <span class="n">_2</span> <span class="o">:=</span> <span class="n">d</span><span class="p">,</span> <span class="n">log</span><span class="p">(</span><span class="s1">&#39;c + d&#39;</span><span class="p">,</span> <span class="n">_1</span><span class="p">,</span> <span class="n">_2</span><span class="p">),</span> <span class="n">_1</span> <span class="o">+</span> <span class="n">_2</span><span class="p">)[</span><span class="mi">3</span><span class="p">],</span> <span class="n">log</span><span class="p">(</span><span class="s1">&#39;-(c + d)&#39;</span><span class="p">,</span> <span class="n">_1</span><span class="p">),</span> <span class="o">-</span><span class="n">_1</span><span class="p">)[</span><span class="mi">2</span><span class="p">],</span> <span class="n">log</span><span class="p">(</span><span class="s1">&#39;(a * b) - -(c + d)&#39;</span><span class="p">,</span> <span class="n">_0</span><span class="p">,</span> <span class="n">_1</span><span class="p">),</span> <span class="n">_0</span> <span class="o">-</span> <span class="n">_1</span><span class="p">)[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">_0</span> <span class="o">:=</span> <span class="p">(</span><span class="n">_1</span> <span class="o">:=</span> <span class="p">(</span><span class="n">_1</span> <span class="o">:=</span> <span class="n">a</span><span class="p">,</span> <span class="n">_2</span> <span class="o">:=</span> <span class="n">c</span><span class="p">,</span> <span class="n">log</span><span class="p">(</span><span class="s1">&#39;a - c&#39;</span><span class="p">,</span> <span class="n">_1</span><span class="p">,</span> <span class="n">_2</span><span class="p">),</span> <span class="n">_1</span> <span class="o">-</span> <span class="n">_2</span><span class="p">)[</span><span class="mi">3</span><span class="p">],</span> <span class="n">log</span><span class="p">(</span><span class="s1">&#39;~(a - c)&#39;</span><span class="p">,</span> <span class="n">_1</span><span class="p">),</span> <span class="o">~</span><span class="n">_1</span><span class="p">)[</span><span class="mi">2</span><span class="p">],</span> <span class="n">_1</span> <span class="o">:=</span> <span class="p">(</span><span class="n">_1</span> <span class="o">:=</span> <span class="n">b</span><span class="p">,</span> <span class="n">_2</span> <span class="o">:=</span> <span class="n">d</span><span class="p">,</span> <span class="n">log</span><span class="p">(</span><span class="s1">&#39;b ^ d&#39;</span><span class="p">,</span> <span class="n">_1</span><span class="p">,</span> <span class="n">_2</span><span class="p">),</span> <span class="n">_1</span> <span class="o">^</span> <span class="n">_2</span><span class="p">)[</span><span class="mi">3</span><span class="p">],</span> <span class="n">log</span><span class="p">(</span><span class="s1">&#39;~(a - c) + (b ^ d)&#39;</span><span class="p">,</span> <span class="n">_0</span><span class="p">,</span> <span class="n">_1</span><span class="p">),</span> <span class="n">_0</span> <span class="o">+</span> <span class="n">_1</span><span class="p">)[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">z</span> <span class="o">=</span> <span class="p">(</span><span class="n">_0</span> <span class="o">:=</span> <span class="n">x</span><span class="p">,</span> <span class="n">_1</span> <span class="o">:=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">1</span><span class="p">,</span> <span class="n">log</span><span class="p">(</span><span class="s1">&#39;x // (abs(y) or 1)&#39;</span><span class="p">,</span> <span class="n">_0</span><span class="p">,</span> <span class="n">_1</span><span class="p">),</span> <span class="n">_0</span> <span class="o">//</span> <span class="n">_1</span><span class="p">)[</span><span class="mi">3</span><span class="p">]</span>
 
    <span class="k">return</span> <span class="p">(</span><span class="n">_0</span> <span class="o">:=</span> <span class="p">(</span><span class="n">_1</span> <span class="o">:=</span> <span class="p">(</span><span class="n">_2</span> <span class="o">:=</span> <span class="n">z</span><span class="p">,</span> <span class="n">_3</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">log</span><span class="p">(</span><span class="s1">&#39;z &lt; 0&#39;</span><span class="p">,</span> <span class="n">_2</span><span class="p">,</span> <span class="n">_3</span><span class="p">),</span> <span class="n">_2</span> <span class="o">&lt;</span> <span class="n">_3</span><span class="p">)[</span><span class="mi">3</span><span class="p">],</span> <span class="n">_2</span> <span class="o">:=</span> <span class="p">(</span><span class="n">_2</span> <span class="o">:=</span> <span class="n">z</span><span class="p">,</span> <span class="n">log</span><span class="p">(</span><span class="s1">&#39;-z&#39;</span><span class="p">,</span> <span class="n">_2</span><span class="p">),</span> <span class="o">-</span><span class="n">_2</span><span class="p">)[</span><span class="mi">2</span><span class="p">],</span> <span class="n">log</span><span class="p">(</span><span class="s1">&#39;(z &lt; 0) * -z&#39;</span><span class="p">,</span> <span class="n">_1</span><span class="p">,</span> <span class="n">_2</span><span class="p">),</span> <span class="n">_1</span> <span class="o">*</span> <span class="n">_2</span><span class="p">)[</span><span class="mi">3</span><span class="p">],</span> <span class="n">_1</span> <span class="o">:=</span> <span class="p">(</span><span class="n">_1</span> <span class="o">:=</span> <span class="p">(</span><span class="n">_2</span> <span class="o">:=</span> <span class="n">z</span><span class="p">,</span> <span class="n">_3</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">log</span><span class="p">(</span><span class="s1">&#39;z &gt;= 0&#39;</span><span class="p">,</span> <span class="n">_2</span><span class="p">,</span> <span class="n">_3</span><span class="p">),</span> <span class="n">_2</span> <span class="o">&gt;=</span> <span class="n">_3</span><span class="p">)[</span><span class="mi">3</span><span class="p">],</span> <span class="n">_2</span> <span class="o">:=</span> <span class="p">(</span><span class="n">_2</span> <span class="o">:=</span> <span class="n">z</span><span class="p">,</span> <span class="n">log</span><span class="p">(</span><span class="s1">&#39;+z&#39;</span><span class="p">,</span> <span class="n">_2</span><span class="p">),</span> <span class="o">+</span><span class="n">_2</span><span class="p">)[</span><span class="mi">2</span><span class="p">],</span> <span class="n">log</span><span class="p">(</span><span class="s1">&#39;(z &gt;= 0) * +z&#39;</span><span class="p">,</span> <span class="n">_1</span><span class="p">,</span> <span class="n">_2</span><span class="p">),</span> <span class="n">_1</span> <span class="o">*</span> <span class="n">_2</span><span class="p">)[</span><span class="mi">3</span><span class="p">],</span> <span class="n">log</span><span class="p">(</span><span class="s1">&#39;(z &lt; 0) * -z + (z &gt;= 0) * +z&#39;</span><span class="p">,</span> <span class="n">_0</span><span class="p">,</span> <span class="n">_1</span><span class="p">),</span> <span class="n">_0</span> <span class="o">+</span> <span class="n">_1</span><span class="p">)[</span><span class="mi">3</span><span class="p">]</span>
</code></pre>
</div>

<p>Now lets compile and execute these functions to make sure everything still works.</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="k">def</span><span class="w"> </span><span class="nf">log</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>  <span class="c1"># log function for the instrumented code</span>
<span class="o">...</span>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;src: </span><span class="si">{</span><span class="n">s</span><span class="si">!r}</span><span class="s1">, args: </span><span class="si">{</span><span class="n">args</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">exec</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">original_ns</span> <span class="o">:=</span> <span class="p">{})</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">exec</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="n">inst_ns</span> <span class="o">:=</span> <span class="p">{</span><span class="s1">&#39;log&#39;</span><span class="p">:</span> <span class="n">log</span><span class="p">})</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">original_shape_score</span> <span class="o">=</span> <span class="n">original_ns</span><span class="p">[</span><span class="s1">&#39;shape_score&#39;</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">inst_shape_score</span> <span class="o">=</span> <span class="n">inst_ns</span><span class="p">[</span><span class="s1">&#39;shape_score&#39;</span><span class="p">]</span>
</code></pre>
</div>

<p>Here we execute them the with the same sets of values to make sure everything comes out the same. In addition, the
instrumented code will log the source being executed and the arguments to those expressions (or do whatever else you
want the log function to do).</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="nb">print</span><span class="p">(</span><span class="n">original_shape_score</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="mi">1</span>

<span class="o">&gt;&gt;&gt;</span> <span class="nb">print</span><span class="p">(</span><span class="n">inst_shape_score</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">src</span><span class="p">:</span> <span class="s1">&#39;a * b&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">src</span><span class="p">:</span> <span class="s1">&#39;c + d&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">src</span><span class="p">:</span> <span class="s1">&#39;-(c + d)&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="p">(</span><span class="mi">7</span><span class="p">,)</span>
<span class="n">src</span><span class="p">:</span> <span class="s1">&#39;(a * b) - -(c + d)&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">7</span><span class="p">)</span>
<span class="n">src</span><span class="p">:</span> <span class="s1">&#39;a - c&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">src</span><span class="p">:</span> <span class="s1">&#39;~(a - c)&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,)</span>
<span class="n">src</span><span class="p">:</span> <span class="s1">&#39;b ^ d&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">src</span><span class="p">:</span> <span class="s1">&#39;~(a - c) + (b ^ d)&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<span class="n">src</span><span class="p">:</span> <span class="s1">&#39;x // (abs(y) or 1)&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
<span class="n">src</span><span class="p">:</span> <span class="s1">&#39;z &lt; 0&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">src</span><span class="p">:</span> <span class="s1">&#39;-z&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span>
<span class="n">src</span><span class="p">:</span> <span class="s1">&#39;(z &lt; 0) * -z&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">src</span><span class="p">:</span> <span class="s1">&#39;z &gt;= 0&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">src</span><span class="p">:</span> <span class="s1">&#39;+z&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span>
<span class="n">src</span><span class="p">:</span> <span class="s1">&#39;(z &gt;= 0) * +z&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">src</span><span class="p">:</span> <span class="s1">&#39;(z &lt; 0) * -z + (z &gt;= 0) * +z&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="mi">1</span>
</code></pre>
</div>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="nb">print</span><span class="p">(</span><span class="n">original_shape_score</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="mi">2</span>

<span class="o">&gt;&gt;&gt;</span> <span class="nb">print</span><span class="p">(</span><span class="n">inst_shape_score</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">src</span><span class="p">:</span> <span class="s1">&#39;a * b&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">src</span><span class="p">:</span> <span class="s1">&#39;c + d&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">src</span><span class="p">:</span> <span class="s1">&#39;-(c + d)&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="p">(</span><span class="mi">7</span><span class="p">,)</span>
<span class="n">src</span><span class="p">:</span> <span class="s1">&#39;(a * b) - -(c + d)&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="o">-</span><span class="mi">7</span><span class="p">)</span>
<span class="n">src</span><span class="p">:</span> <span class="s1">&#39;a - c&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">src</span><span class="p">:</span> <span class="s1">&#39;~(a - c)&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,)</span>
<span class="n">src</span><span class="p">:</span> <span class="s1">&#39;b ^ d&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">src</span><span class="p">:</span> <span class="s1">&#39;~(a - c) + (b ^ d)&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<span class="n">src</span><span class="p">:</span> <span class="s1">&#39;x // (abs(y) or 1)&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">src</span><span class="p">:</span> <span class="s1">&#39;z &lt; 0&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">src</span><span class="p">:</span> <span class="s1">&#39;-z&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,)</span>
<span class="n">src</span><span class="p">:</span> <span class="s1">&#39;(z &lt; 0) * -z&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span>
<span class="n">src</span><span class="p">:</span> <span class="s1">&#39;z &gt;= 0&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">src</span><span class="p">:</span> <span class="s1">&#39;+z&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,)</span>
<span class="n">src</span><span class="p">:</span> <span class="s1">&#39;(z &gt;= 0) * +z&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">src</span><span class="p">:</span> <span class="s1">&#39;(z &lt; 0) * -z + (z &gt;= 0) * +z&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="mi">2</span>
</code></pre>
</div>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="nb">print</span><span class="p">(</span><span class="n">original_shape_score</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="mi">10</span>

<span class="o">&gt;&gt;&gt;</span> <span class="nb">print</span><span class="p">(</span><span class="n">inst_shape_score</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">src</span><span class="p">:</span> <span class="s1">&#39;a * b&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">src</span><span class="p">:</span> <span class="s1">&#39;c + d&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">src</span><span class="p">:</span> <span class="s1">&#39;-(c + d)&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="p">(</span><span class="mi">13</span><span class="p">,)</span>
<span class="n">src</span><span class="p">:</span> <span class="s1">&#39;(a * b) - -(c + d)&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">13</span><span class="p">)</span>
<span class="n">src</span><span class="p">:</span> <span class="s1">&#39;a - c&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>
<span class="n">src</span><span class="p">:</span> <span class="s1">&#39;~(a - c)&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">6</span><span class="p">,)</span>
<span class="n">src</span><span class="p">:</span> <span class="s1">&#39;b ^ d&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">src</span><span class="p">:</span> <span class="s1">&#39;~(a - c) + (b ^ d)&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">)</span>
<span class="n">src</span><span class="p">:</span> <span class="s1">&#39;x // (abs(y) or 1)&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">src</span><span class="p">:</span> <span class="s1">&#39;z &lt; 0&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">src</span><span class="p">:</span> <span class="s1">&#39;-z&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="p">(</span><span class="mi">10</span><span class="p">,)</span>
<span class="n">src</span><span class="p">:</span> <span class="s1">&#39;(z &lt; 0) * -z&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span><span class="p">)</span>
<span class="n">src</span><span class="p">:</span> <span class="s1">&#39;z &gt;= 0&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">src</span><span class="p">:</span> <span class="s1">&#39;+z&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="p">(</span><span class="mi">10</span><span class="p">,)</span>
<span class="n">src</span><span class="p">:</span> <span class="s1">&#39;(z &gt;= 0) * +z&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">src</span><span class="p">:</span> <span class="s1">&#39;(z &lt; 0) * -z + (z &gt;= 0) * +z&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="mi">10</span>
</code></pre>
</div>
</div>

                
                
                
            </section>
    </main>
</body>
</html>